<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Tech News — Éducation numérique & IA</title>
  <meta name="description" content="Sélection automatique des actualités importantes (éducation numérique, IA, recherches, conférences, politiques, standards)."/>

  <link rel="stylesheet" href="/style.css">
  <script defer src="/assets/js/nav.js"></script>

  <style>
    :root { --line: var(--border); }
    main { max-width:1100px; margin: 10px auto 28px; padding: 0 16px; }
    header.page { max-width:1100px; margin: calc(10px + var(--nt-nav-h,60px)) auto 8px; padding: 0 16px; }
    .title { margin: 4px 0 4px; }
    .lead  { margin: 0 0 10px; }

    .toolbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .toolbar .chip { cursor:pointer; }
    .toolbar .sep { opacity:.4; }

    .grid { display:grid; gap:16px; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); }
    .card { background: var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; display:flex; flex-direction:column; gap:8px; box-shadow: var(--shadow); }
    .thumb { width:100%; aspect-ratio:16/9; object-fit:cover; border-radius:10px; border:1px solid var(--line); background:#0d1b2b; }
    .meta { color: var(--muted); font-size:.92rem; margin:0; }
    .r { margin:0; }
    .tags { display:flex; flex-wrap:wrap; gap:6px; }
    .tag { border:1px solid var(--line); border-radius:999px; padding:2px 8px; font-size:.85rem }

    .pager { display:flex; gap:8px; align-items:center; justify-content:flex-end; flex-wrap:wrap; margin:12px 0 0; }
    .pager a, .pager span, .toolbar .chip { padding:6px 10px; border:1px solid var(--line); border-radius:10px; background: var(--surface); color: var(--text); text-decoration:none; }
    .pager .current { font-weight:700; background: color-mix(in oklab, var(--surface), #fff 6%); }
    .muted { color: var(--muted); }
  </style>
</head>
<body>
  <header class="page" aria-label="En-tête page Tech News">
    <h1 class="title">Tech News</h1>
    <p class="lead">Actus importantes + <strong>recherche & conférences</strong> (LLM/outils inclus), triées par pertinence/date.</p>

    <div class="toolbar">
      <button id="refresh" class="btn">Actualiser</button>
      <label class="chip"><input type="checkbox" id="showMeta"> Métadonnées</label>
      <span class="sep">|</span>

      <span class="muted">Affichage :</span>
      <a href="#" data-view="pages" class="chip" id="viewPages">Par pages</a>
      <a href="#" data-view="days"  class="chip" id="viewDays">Par jours</a>

      <span class="sep">|</span>
      <label class="select">Page size
        <select id="pageSize">
          <option>10</option>
          <option selected>20</option>
          <option>30</option>
          <option>50</option>
        </select>
      </label>

      <label>Filtrer
        <input type="search" id="q" placeholder="titre, source, tag…">
      </label>

      <span class="sep">|</span>
      <label>Profil
        <select id="profile">
          <option value="balanced">Mix</option>
          <option value="research">Recherche</option>
          <option value="policy">Politiques</option>
        </select>
      </label>
    </div>

    <p id="stamp" class="muted" style="margin:6px 0 0">—</p>
  </header>

  <main>
    <div id="pagerTop" class="pager"></div>
    <div id="grid" class="grid" aria-live="polite"></div>
    <div id="pagerBottom" class="pager"></div>
  </main>

  <template id="card-tpl">
    <article class="card">
      <img class="thumb" alt="">
      <h3 class="h3 t"></h3>
      <p class="meta"></p>
      <p class="r"></p>
      <p class="tags"></p>
    </article>
  </template>

  <script>
    const url = new URL(location.href);
    const params = url.searchParams;
    const grid = document.getElementById("grid");
    const stamp = document.getElementById("stamp");
    const refreshBtn = document.getElementById("refresh");
    const showMeta = document.getElementById("showMeta");
    const pagerTop = document.getElementById("pagerTop");
    const pagerBottom = document.getElementById("pagerBottom");
    const pageSizeSel = document.getElementById("pageSize");
    const qInput = document.getElementById("q");
    const viewPagesBtn = document.getElementById("viewPages");
    const viewDaysBtn  = document.getElementById("viewDays");
    const profileSel   = document.getElementById("profile");

    const VIEW = (params.get("view") || "pages");
    const PAGE_SIZE_DEFAULT = clampInt(params.get("n") || "20", 5, 100);
    let PAGE_SIZE = PAGE_SIZE_DEFAULT;
    let PAGE = clampInt(params.get("p") || "1", 1, 9999);
    let DAY_INDEX = clampInt(params.get("d") || "1", 1, 9999);
    let FILTER = (params.get("q") || "").trim();

    const profileURL = (params.get("profile") || localStorage.getItem("newsProfile") || "balanced").toLowerCase();
    profileSel.value = ["balanced","research","policy"].includes(profileURL) ? profileURL : "balanced";

    pageSizeSel.value = String(PAGE_SIZE_DEFAULT);
    qInput.value = FILTER;
    (VIEW === "days" ? viewDaysBtn : viewPagesBtn).setAttribute("aria-current", "page");

    const tz = "Europe/Zurich";
    const dayFmt = new Intl.DateTimeFormat('sv-SE', { timeZone: tz, year:'numeric', month:'2-digit', day:'2-digit' });

    function clampInt(v, a, b){ v = parseInt(v,10); return isFinite(v) ? Math.max(a, Math.min(b, v)) : a; }
    function toHttps(u){ if(!u) return u; if(u.startsWith("//")) return "https:"+u; if(u.startsWith("http://")) return "https://"+u.slice(7); return u; }

    let DATA = null;

    function makeUrls(profile) {
      const fname = (profile === "balanced") ? "feed.json" : `feed-${profile}.json`;
      return [
        `/news/${fname}`,
        `/api/news?profile=${encodeURIComponent(profile)}`,
        `https://raw.githubusercontent.com/Nix177/CV/main/public/news/${fname}`
      ];
    }

    async function fetchFirstOk(urls) {
      for (const u of urls) {
        try {
          const r = await fetch(u, { cache: "no-store" });
          if (r.ok) return await r.json();
        } catch {}
      }
      throw new Error("Aucune source disponible");
    }

    async function load() {
      try {
        const data = await fetchFirstOk(makeUrls(profileSel.value));
        DATA = data;
        render();
      } catch (e) {
        grid.innerHTML = "<p class='muted'>Pas encore de données. Réessaie dans une minute.</p>";
        stamp.textContent = "—";
      }
    }

    function filterItems(items) {
      const q = FILTER.toLowerCase();
      if (!q) return items;
      return items.filter(it =>
        (it.title||"").toLowerCase().includes(q) ||
        (it.source||"").toLowerCase().includes(q) ||
        (it.tags||[]).some(t => String(t).toLowerCase().includes(q))
      );
    }

    function groupByDay(items) {
      const map = new Map();
      for (const it of items) {
        const d = it.published ? new Date(it.published) : null;
        const key = d ? dayFmt.format(d) : "0000-00-00";
        if (!map.has(key)) map.set(key, []);
        map.get(key).push(it);
      }
      for (const arr of map.values()) arr.sort((a,b)=> new Date(b.published||0) - new Date(a.published||0));
      const days = Array.from(map.keys()).sort((a,b)=> b.localeCompare(a));
      return { map, days };
    }

    function pagerLinks(count, current, qs, labelPrev = "◀ Préc.", labelNext = "Suiv. ▶") {
      const pages = Math.max(1, count);
      let html = "";
      const mk = (i, lbl, cls="") => `<a class="${cls}" href="?${qs}&${VIEW==='pages'?'p':'d'}=${i}">${lbl}</a>`;
      const cur = (i) => `<span class="current">${i}</span>`;
      if (current > 1) html += mk(current-1, labelPrev);
      for (let i=1; i<=pages; i++) html += (i===current ? cur(i) : mk(i, i));
      if (current < pages) html += mk(current+1, labelNext);
      return html;
    }

    function buildQS(extra={}) {
      const p = new URLSearchParams();
      p.set("view", VIEW);
      p.set("n", PAGE_SIZE);
      p.set("profile", profileSel.value);
      if (FILTER) p.set("q", FILTER);
      if (VIEW === "pages") p.set("p", PAGE);
      if (VIEW === "days")  p.set("d", DAY_INDEX);
      for (const [k,v] of Object.entries(extra)) {
        if (v==null) continue;
        p.set(k, v);
      }
      return p.toString();
    }

    function render() {
      const itemsAll = filterItems(DATA?.items || []);
      const total = itemsAll.length;

      stamp.textContent =
        `Généré le ${new Date(DATA.generatedAt).toLocaleString()}. ` +
        `${DATA.totalPublished ?? total} sélection(s).` +
        (showMeta.checked && DATA.profile ? ` • profil: ${DATA.profile}` : "") +
        (showMeta.checked && DATA.debug?.analysisFailed ? " • OpenAI indisponible" : "");

      grid.innerHTML = "";
      pagerTop.innerHTML = pagerBottom.innerHTML = "";

      if (VIEW === "pages") {
        const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
        if (PAGE > pages) PAGE = pages;
        const start = (PAGE-1) * PAGE_SIZE;
        renderSlice(itemsAll.slice(start, start + PAGE_SIZE));
        const qs = buildQS({ p: undefined });
        pagerTop.innerHTML = pagerLinks(pages, PAGE, qs);
        pagerBottom.innerHTML = pagerTop.innerHTML;
      } else {
        const { map, days } = groupByDay(itemsAll);
        const dPages = Math.max(1, days.length);
        if (DAY_INDEX > dPages) DAY_INDEX = dPages;
        const dayKey = days[DAY_INDEX-1];
        renderSlice(map.get(dayKey) || []);
        const qs = buildQS({ d: undefined });
        pagerTop.innerHTML = pagerLinks(dPages, DAY_INDEX, qs, "◀ Jour préc.", "Jour suiv. ▶");
        pagerBottom.innerHTML = pagerTop.innerHTML;
      }
    }

    function renderSlice(slice) {
      if (!slice.length) {
        grid.innerHTML = "<p class='muted'>Aucune actualité pour ces critères.</p>";
        return;
      }
      slice.forEach(it => {
        const tpl = document.getElementById("card-tpl").content.cloneNode(true);
        const img = tpl.querySelector(".thumb");
        try {
          const h = new URL(it.url).hostname;
          const fallback = `https://www.google.com/s2/favicons?domain=${encodeURIComponent(h)}&sz=128`;
          img.src = toHttps(it.image || fallback);
        } catch { img.src = toHttps(it.image || ""); }
        img.alt = it.source ? `Image — ${it.source}` : "Image";

        const a = document.createElement("a");
        a.href = it.url; a.target = "_blank"; a.rel = "noopener"; a.textContent = it.title;
        tpl.querySelector(".t").appendChild(a);

        const d = it.published ? new Date(it.published) : null;
        const meta = `${it.source || "—"}${d ? " • " + d.toLocaleDateString() : ""}${showMeta.checked ? ` • score ${it.score}` : ""}`;
        tpl.querySelector(".meta").textContent = meta;

        tpl.querySelector(".r").textContent = it.resume_fr || "";
        tpl.querySelector(".tags").innerHTML = (it.tags || []).map(t => `<span class="tag">${t}</span>`).join(" ");
        grid.appendChild(tpl);
      });
    }

    // UI
    refreshBtn.addEventListener("click", load);
    showMeta.addEventListener("change", render);
    pageSizeSel.addEventListener("change", () => {
      PAGE_SIZE = clampInt(pageSizeSel.value, 5, 100);
      params.set("n", String(PAGE_SIZE));
      if (VIEW === "pages") params.set("p", "1");
      url.search = params.toString(); location.href = url.toString();
    });
    qInput.addEventListener("input", () => {
      FILTER = qInput.value.trim();
      if (FILTER) params.set("q", FILTER); else params.delete("q");
      if (VIEW === "pages") params.set("p", "1"); else params.set("d","1");
      history.replaceState(null, "", "?"+params.toString());
      render();
    });
    function switchView(v) {
      params.set("view", v);
      if (v === "pages") { params.set("p","1"); params.set("n", String(PAGE_SIZE)); params.delete("d"); }
      else { params.set("d","1"); params.delete("p"); }
      url.search = params.toString(); location.href = url.toString();
    }
    viewPagesBtn.addEventListener("click", (e)=>{ e.preventDefault(); switchView("pages"); });
    viewDaysBtn.addEventListener("click", (e)=>{ e.preventDefault(); switchView("days"); });

    profileSel.addEventListener("change", () => {
      localStorage.setItem("newsProfile", profileSel.value);
      params.set("profile", profileSel.value);
      params.set("p", "1"); params.set("d", "1");
      url.search = params.toString(); location.href = url.toString();
    });

    load();
  </script>
</body>
</html>
