<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Tech News — Éducation numérique & IA</title>
  <meta name="description" content="Sélection automatique des actualités importantes (éducation numérique, IA, politiques, standards) + articles de recherche et conférences."/>
  <style>
    :root { --fg:#111; --muted:#666; --card:#fff; --line:#e6e6e6; --bg:#fafafa; }
    @media (prefers-color-scheme: dark) {
      :root { --fg:#eaeaea; --muted:#9aa0a6; --card:#151515; --line:#2a2a2a; --bg:#0b0b0b; }
    }
    * { box-sizing:border-box }
    html,body { margin:0; padding:0; background:var(--bg); color:var(--fg); font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
    header { max-width:980px; margin:24px auto 8px; padding:0 16px }
    h1 { margin:0 0 8px; font-size:clamp(1.4rem,2vw + 1rem,2rem) }
    .sub { margin:0 0 12px; color:var(--muted) }
    .toolbar { display:flex; gap:12px; align-items:center; margin:8px 0; flex-wrap:wrap }
    button { padding:8px 12px; border-radius:10px; border:1px solid var(--line); background:var(--card); color:var(--fg); cursor:pointer }
    button:hover { filter:brightness(1.05) }
    .chk { color:var(--muted); font-size:0.95rem }
    .stamp { color:var(--muted); font-size:0.9rem; margin:4px 0 0 }

    .grid { max-width:980px; margin:0 auto; padding:16px; display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:16px }
    .card { border:1px solid var(--line); border-radius:14px; background:var(--card); padding:14px; display:flex; flex-direction:column; gap:8px }
    .thumb { width:100%; aspect-ratio:16/9; object-fit:cover; border-radius:10px; border:1px solid var(--line); background:#ddd }
    .card h2 { font-size:1.05rem; margin:0; }
    .card h2 a { color:inherit; text-decoration:none }
    .card h2 a:hover { text-decoration:underline }
    .meta { color:var(--muted); font-size:0.9rem; margin:0 }
    .r { margin:0 }
    .tags { display:flex; flex-wrap:wrap; gap:6px }
    .tag { border:1px solid var(--line); border-radius:999px; padding:2px 8px; font-size:0.85rem }
    .err,.info { color:var(--muted); padding:16px }
    footer { max-width:980px; margin:8px auto 32px; padding:0 16px; color:var(--muted); font-size:0.9rem }

    /* Pager */
    .pager { max-width:980px; margin:8px auto 0; padding:0 16px; display:flex; gap:8px; align-items:center; justify-content:flex-end; flex-wrap:wrap }
    .pager button, .pager a { padding:6px 10px; border:1px solid var(--line); border-radius:10px; background:var(--card); color:var(--fg); text-decoration:none }
    .pager .current { font-weight:600 }
  </style>
</head>
<body>
  <header>
    <h1>Tech News</h1>
    <p class="sub">Actus “haute importance” + <strong>recherche & conférences</strong> : régulation, politiques, standards, articles, CFP, proceedings, cybersécurité.</p>
    <div class="toolbar">
      <button id="refresh">Actualiser</button>
      <label class="chk"><input type="checkbox" id="showMeta"/> Afficher les métadonnées</label>
    </div>
    <p id="stamp" class="stamp">—</p>
  </header>

  <div id="pager" class="pager" aria-label="Pagination"></div>
  <main id="grid" class="grid" aria-live="polite"></main>
  <div id="pager-bottom" class="pager" aria-label="Pagination"></div>

  <template id="card-tpl">
    <article class="card">
      <img class="thumb" alt="">
      <h2 class="t"></h2>
      <p class="meta"></p>
      <p class="r"></p>
      <p class="tags"></p>
    </article>
  </template>

  <footer>
    <p>Sources : journaux & conférences (arXiv, SoLAR/JLA, EDM, SIGCSE, npj Science of Learning, Frontiers) + institutions (UNESCO, OCDE, CNIL, etc.).</p>
  </footer>

  <script>
    const grid = document.getElementById("grid");
    const stamp = document.getElementById("stamp");
    const refreshBtn = document.getElementById("refresh");
    const showMeta = document.getElementById("showMeta");
    const pagerTop = document.getElementById("pager");
    const pagerBottom = document.getElementById("pager-bottom");

    const PAGE_SIZE = 20;
    let DATA = null;
    let PAGE = parseInt(new URLSearchParams(location.search).get("p") || "1", 10);
    if (PAGE < 1) PAGE = 1;

    async function fetchFirstOk(urls) {
      for (const u of urls) {
        try {
          const r = await fetch(u, { cache: "no-store" });
          if (r.ok) return await r.json();
        } catch {}
      }
      throw new Error("Aucune source disponible");
    }

    async function load() {
      try {
        const data = await fetchFirstOk([
          "/news/feed.json",
          "/api/news",
          "https://raw.githubusercontent.com/Nix177/CV/main/public/news/feed.json"
        ]);
        DATA = data;
        render();
      } catch (e) {
        grid.innerHTML = "<p class='err'>Pas encore de données. Réessaie dans une minute.</p>";
        stamp.textContent = "—";
      }
    }

    function renderPager(total, page, size) {
      const pages = Math.max(1, Math.ceil(total / size));
      const makeLink = (p, label, cls="") =>
        `<a href="?p=${p}" class="${cls}">${label}</a>`;

      let html = "";
      if (page > 1) html += makeLink(page-1, "◀ Préc.");
      for (let i=1; i<=pages; i++) {
        html += (i === page)
          ? `<span class="current">${i}</span>`
          : makeLink(i, i);
      }
      if (page < pages) html += makeLink(page+1, "Suiv. ▶");
      return html;
    }

    function render() {
      const items = DATA?.items || [];
      const total = items.length;
      const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      if (PAGE > pages) PAGE = pages;

      pagerTop.innerHTML = renderPager(total, PAGE, PAGE_SIZE);
      pagerBottom.innerHTML = pagerTop.innerHTML;

      grid.innerHTML = "";
      stamp.textContent =
        `Généré le ${new Date(DATA.generatedAt).toLocaleString()}. ` +
        `${DATA.totalPublished ?? total} sélection(s).` +
        (showMeta.checked && DATA.profile ? ` • profil: ${DATA.profile}` : "") +
        (showMeta.checked && DATA.debug?.analysisFailed ? " • OpenAI indisponible" : "");

      const start = (PAGE-1) * PAGE_SIZE;
      const slice = items.slice(start, start + PAGE_SIZE);

      slice.forEach(it => {
        const tpl = document.getElementById("card-tpl").content.cloneNode(true);
        const img = tpl.querySelector(".thumb");
        img.src = it.image || `https://www.google.com/s2/favicons?domain=${encodeURIComponent(new URL(it.url).hostname)}&sz=128`;
        img.alt = it.source ? `Image – ${it.source}` : "Image";

        const a = document.createElement("a");
        a.href = it.url; a.target = "_blank"; a.rel = "noopener"; a.textContent = it.title;
        tpl.querySelector(".t").appendChild(a);

        const d = it.published ? new Date(it.published) : null;
        const meta = `${it.source || "—"}${d ? " • " + d.toLocaleDateString() : ""}${showMeta.checked ? ` • score ${it.score}` : ""}`;
        tpl.querySelector(".meta").textContent = meta;

        tpl.querySelector(".r").textContent = it.resume_fr || "";
        tpl.querySelector(".tags").innerHTML = (it.tags || []).map(t => `<span class="tag">${t}</span>`).join(" ");
        grid.appendChild(tpl);
      });

      if (!slice.length) grid.innerHTML = "<p class='info'>Aucune actualité disponible pour cette page.</p>";
    }

    refreshBtn.addEventListener("click", load);
    showMeta.addEventListener("change", render);
    load();
  </script>
</body>
</html>
