<!doctype html>
<html lang="fr">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Tech News — Éducation numérique & IA</title>
  <meta name="description"
    content="Sélection automatique des actualités importantes (éducation numérique, IA, recherches, conférences, politiques, standards)." />

  <link rel="stylesheet" href="/style.css">
  <script defer src="/assets/js/nav.js"></script>

  <style>
    :root {
      --line: var(--border);
    }

    main {
      max-width: 1100px;
      margin: 10px auto 28px;
      padding: 0 16px;
    }

    header.page {
      max-width: 1100px;
      margin: calc(10px + var(--nt-nav-h, 60px)) auto 8px;
      padding: 0 16px;
    }

    .title {
      margin: 4px 0 4px;
    }

    .lead {
      margin: 0 0 10px;
    }

    .toolbar {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .toolbar .chip {
      cursor: pointer;
    }

    .toolbar .sep {
      opacity: .4;
    }

    .grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow: var(--shadow);
    }

    .thumb {
      width: 100%;
      aspect-ratio: 16/9;
      object-fit: cover;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: #0d1b2b;
    }

    .meta {
      color: var(--muted);
      font-size: .92rem;
      margin: 0;
    }

    .r {
      margin: 0;
    }

    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .tag {
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 2px 8px;
      font-size: .85rem
    }

    .pager {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: flex-end;
      flex-wrap: wrap;
      margin: 12px 0 0;
    }

    .pager a,
    .pager span,
    .toolbar .chip {
      padding: 6px 10px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: var(--surface);
      color: var(--text);
      text-decoration: none;
    }

    .pager .current {
      font-weight: 700;
      background: color-mix(in oklab, var(--surface), #fff 6%);
    }

    .muted {
      color: var(--muted);
    }

    .reason {
      font-size: .9rem;
      color: var(--muted);
      margin: 0;
    }

    .bd {
      font-variant-numeric: tabular-nums;
    }

    .weights {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .weights .row {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .weights input[type="range"] {
      width: 140px;
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    }

    details.explain {
      margin-top: 8px;
    }

    /* Advanced panel */
    details#adv summary {
      list-style: none;
    }

    details#adv[open]>div {
      margin-top: 8px;
    }

    details#adv input {
      margin-left: 6px;
    }

    /* overlay build / refresh */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .dialog {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 18px;
      width: min(520px, 92vw);
      color: var(--text);
      box-shadow: var(--shadow);
    }

    .progress {
      width: 100%;
      height: 10px;
      border: 1px solid var(--line);
      border-radius: 999px;
      overflow: hidden;
      margin: 10px 0 0;
      background: var(--surface);
    }

    .bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #7aa2f7, #a0c2ff);
      transition: width .5s ease;
    }

    .rowb {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
  </style>
  <script defer src="/_vercel/insights/script.js"></script>
</head>

<body>
  <header class="page" aria-label="En-tête page Tech News">
    <h1 class="title">Tech News</h1>
    <p class="lead">Actus importantes + <strong>recherche & conférences</strong> (LLM/outils inclus), triées par
      pertinence/date.</p>

    <div class="toolbar">
      <button id="refresh" class="btn">Actualiser</button>
      <label class="chip"><input type="checkbox" id="showMeta"> Métadonnées</label>
      <span class="sep">|</span>

      <span class="muted">Affichage :</span>
      <a href="#" data-view="pages" class="chip" id="viewPages">Par pages</a>
      <a href="#" data-view="days" class="chip" id="viewDays">Par jours</a>

      <span class="sep">|</span>
      <!-- Filtres Catégories -->
      <span class="muted">Catégorie :</span>
      <select id="catFilter">
        <option value="">Tout</option>
        <option value="scientific">Scientifique</option>
        <option value="news">News</option>
        <option value="event">Événement</option>
        <option value="tech_update">Tech Update</option>
      </select>

      <span class="sep">|</span>
      <label class="select">Page size
        <select id="pageSize">
          <option>10</option>
          <option selected>20</option>
          <option>30</option>
          <option>50</option>
        </select>
      </label>

      <label>Filtrer
        <input type="search" id="q" placeholder="titre, source, tag…">
      </label>

      <span class="sep">|</span>
      <label>Profil
        <select id="profile">
          <option value="balanced">Mix</option>
          <option value="research">Recherche</option>
          <option value="policy">Politiques</option>
        </select>
      </label>

      <label title="Seuil de score (0 à 100). Les cartes sous ce seuil sont masquées.">
        Seuil
        <input type="range" id="th" min="0" max="100" step="5" style="vertical-align:middle">
        <span id="thVal" class="bd">—</span>
      </label>
    </div>

    <details class="explain">
      <summary>Comment sont calculés le <strong>score</strong> et le <strong>seuil</strong> ?</summary>
      <p class="muted">
        Les sources sont d'abord filtrées (éducation numérique, IA, EdTech, politiques/standards). Ensuite, chaque item
        reçoit un score global (0-100) combinant plusieurs dimensions (recherche, politiques, institutions, impact
        potentiel
        pour l'enseignement).
      </p>
      <p class="muted bd" id="weightsSum">Poids (normés) R/P/I/M: —</p>
      <div class="weights">
        <div class="row">
          <label>R
            <input type="range" id="wR" min="0" max="100">
            <span id="wRVal" class="bd mono">—</span>
          </label>
        </div>
        <div class="row">
          <label>P
            <input type="range" id="wP" min="0" max="100">
            <span id="wPVal" class="bd mono">—</span>
          </label>
        </div>
        <div class="row">
          <label>I
            <input type="range" id="wI" min="0" max="100">
            <span id="wIVal" class="bd mono">—</span>
          </label>
        </div>
        <div class="row">
          <label>M
            <input type="range" id="wM" min="0" max="100">
            <span id="wMVal" class="bd mono">—</span>
          </label>
        </div>
        <label><input type="checkbox" id="useCustom"> Utiliser ces poids personnalisés (profil courant)</label>
      </div>
      <div class="muted">
        <ul>
          <li><strong>R — Recherche</strong> : articles, journaux, conférences, appels à communications, résultats
            scientifiques.</li>
          <li><strong>P — Politiques</strong> : lois, régulations, standards, cadres/“frameworks”.</li>
          <li><strong>I — Institution</strong> : grandes agences & autorités (UNESCO, OCDE, CNIL, NCSC, ministères…).
          </li>
          <li><strong>M — Impact</strong> : impact direct pour l’enseignement, les élèves/enseignants, l’EdTech.</li>
        </ul>
      </div>
    </details>

    <details id="adv">
      <summary>Options avancées (preview, build GitHub Actions…)</summary>
      <div>
        <div class="rowb">
          <label class="chip"><input type="checkbox" id="previewMode"> Mode preview (ne pas toucher au flux
            global)</label>
          <span class="muted">Le mode preview lit/écrit dans un flux séparé (prévisualisation) sans modifier le flux
            stable.</span>
        </div>
        <div class="rowb">
          <button id="buildBtn" class="btn">Lancer une mise à jour via GitHub Actions</button>
          <span class="muted">Crée un run GitHub Actions qui rafraîchit les news sur le dépôt (profil + poids +
            seuil).</span>
        </div>
      </div>
    </details>
  </header>

  <main>
    <p class="muted" id="stamp">Chargement…</p>
    <div class="grid" id="grid"></div>
    <div class="pager" id="pager"></div>
  </main>

  <template id="card-tpl">
    <article class="card">
      <img class="thumb" alt="Illustration">
      <p class="meta"></p>
      <h2 class="t"></h2>
      <p class="r"></p>
      <div class="tags"></div>
      <p class="reason"></p>
    </article>
  </template>

  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="dialog">
      <h2>Mise à jour du flux</h2>
      <p id="ovlStatus" class="muted">Initialisation…</p>
      <div class="progress">
        <div class="bar" id="ovlBar"></div>
      </div>
      <p class="muted mono" style="margin-top:10px;">Cette opération déclenche un workflow GitHub Actions qui
        reconstruit le flux Tech News.</p>
    </div>
  </div>

  <script>
    const url = new URL(location.href);
    const params = url.searchParams;

    const PAGE_SIZE_DEFAULT = 20;
    let PAGE_SIZE = Math.max(5, Math.min(100, parseInt(params.get("n") || PAGE_SIZE_DEFAULT, 10) || PAGE_SIZE_DEFAULT));
    let VIEW = params.get("view") === "days" ? "days" : "pages";
    let PAGE = Math.max(1, parseInt(params.get("p") || "1", 10) || 1);
    let DAY_INDEX = Math.max(1, parseInt(params.get("d") || "1", 10) || 1);
    const FILTER = (params.get("q") || "").trim();
    let PREVIEW = params.get("preview") === "1";

    const stamp = document.getElementById("stamp");
    const grid = document.getElementById("grid");
    const pager = document.getElementById("pager");

    const refreshBtn = document.getElementById("refresh");
    const showMeta = document.getElementById("showMeta");
    const pageSizeSel = document.getElementById("pageSize");
    const qInput = document.getElementById("q");
    const catFilter = document.getElementById("catFilter");
    const profileSel = document.getElementById("profile");

    const viewPagesBtn = document.getElementById("viewPages");
    const viewDaysBtn = document.getElementById("viewDays");

    const useCustom = document.getElementById("useCustom");
    const wR = document.getElementById("wR");
    const wP = document.getElementById("wP");
    const wI = document.getElementById("wI");
    const wM = document.getElementById("wM");
    const wRVal = document.getElementById("wRVal");
    const wPVal = document.getElementById("wPVal");
    const wIVal = document.getElementById("wIVal");
    const wMVal = document.getElementById("wMVal");
    const weightsSum = document.getElementById("weightsSum");

    const previewModeChk = document.getElementById("previewMode");
    const buildBtn = document.getElementById("buildBtn");
    const overlay = document.getElementById("overlay");
    const ovlStatus = document.getElementById("ovlStatus");
    const ovlBar = document.getElementById("ovlBar");

    pageSizeSel.value = String(PAGE_SIZE);
    qInput.value = FILTER;
    (VIEW === "days" ? viewDaysBtn : viewPagesBtn).setAttribute("aria-current", "page");

    const DEFAULT_W = {
      research: [40, 25, 20, 15],
      balanced: [35, 35, 15, 15],
      policy: [25, 40, 20, 15],
    };

    const profileURL = (params.get("profile") || localStorage.getItem("newsProfile") || "balanced").toLowerCase();
    profileSel.value = ["balanced", "research", "policy"].includes(profileURL) ? profileURL : "balanced";
    let THRESH = clampInt(params.get("t") || "0", 0, 100);

    const customKey = (p) => `newsWeights_${p}`;
    const customFlagKey = (p) => `newsWeightsEnabled_${p}`;
    function readCustomRaw(p) {
      const qs = params.get("w");
      if (qs) return qs.split(",").map(n => clampInt(n, 0, 100));
      const s = localStorage.getItem(customKey(p));
      return s ? s.split(",").map(n => clampInt(n, 0, 100)) : null;
    }
    function readCustomEnabled(p) {
      if (params.has("cw")) return params.get("cw") === "1";
      const v = localStorage.getItem(customFlagKey(p));
      return v ? v === "1" : false;
    }

    let DATA = null;
    let RAW_W = readCustomRaw(profileSel.value) || DEFAULT_W[profileSel.value];
    let USE_CUSTOM = readCustomEnabled(profileSel.value);

    pageSizeSel.value = String(PAGE_SIZE_DEFAULT);
    qInput.value = FILTER;
    (VIEW === "days" ? viewDaysBtn : viewPagesBtn).setAttribute("aria-current", "page");
    useCustom.checked = USE_CUSTOM;
    [wR, wP, wI, wM].forEach((el, i) => el.value = String(RAW_W[i] || 0));
    updateWeightsLabels();

    previewModeChk.checked = PREVIEW;

    function toHttps(u) { if (!u) return ""; if (u.startsWith("//")) return "https:" + u; if (u.startsWith("http://")) return "https://" + u.slice(7); return u; }

    function clampInt(v, min, max) {
      const n = parseInt(v, 10);
      if (isNaN(n)) return min;
      return Math.max(min, Math.min(max, n));
    }

    function currentWeights() {
      if (!USE_CUSTOM) return DEFAULT_W[profileSel.value];
      const arr = [wR, wP, wI, wM].map(el => clampInt(el.value, 0, 100));
      const s = arr.reduce((a, b) => a + b, 0) || 1;
      return arr.map(v => Math.round(v * 100 / s));
    }

    function makeUrls(profile) {
      const base = PREVIEW
        ? (profile === "balanced" ? "feed-preview.json" : `feed-${profile}-preview.json`)
        : (profile === "balanced" ? "feed.json" : `feed-${profile}.json`);
      return [
        `/news/${base}`,
        `https://raw.githubusercontent.com/Nix177/CV/main/public/news/${base}`
      ];
    }
    async function fetchFirstOk(urls) {
      for (const u of urls) {
        try {
          const r = await fetch(u, { cache: "no-store" });
          if (r.ok) return await r.json();
        } catch { }
      }
      throw new Error("Aucune source disponible");
    }

    function updateLabelsExplain() {
      const L = DATA?.debug?.labelsUsed || { research: "Recherche", policy: "Politiques", institution: "Institution", impact: "Impact" };
      const D = DATA?.debug?.descUsed || {};
      const explain = document.querySelector("details.explain .muted");
      if (explain) {
        const ul = explain.querySelector("ul");
        if (ul) {
          ul.innerHTML = `
            <li><strong>R — ${L.research}</strong> : ${D.research || "articles/journaux, conférences, CFP, résultats scientifiques."}</li>
            <li><strong>P — ${L.policy}</strong> : ${D.policy || "lois, régulations, standards, cadres/“frameworks”."}</li>
            <li><strong>I — ${L.institution}</strong> : ${D.institution || "grandes agences & autorités (UNESCO, OCDE, CNIL, NCSC, ministères…)."}
            </li>
            <li><strong>M — ${L.impact}</strong> : ${D.impact || "impact direct pour l’enseignement, les élèves/enseignants, l’EdTech."}</li>
          `;
        }
      }
    }

    function filterItems(items) {
      const q = (qInput.value || "").trim().toLowerCase();
      const cat = catFilter ? catFilter.value : "";

      return items.filter(it => {
        // 1. Category Filter
        if (cat) {
          const tTags = (it.tags || []).map(t => t.toLowerCase());
          const hasTag = tTags.includes(cat);

          let matchesHeuristic = false;
          if (!hasTag) {
            const bd = it.breakdown || {};
            if (cat === "scientific" && bd.research >= 60) matchesHeuristic = true;
            if (cat === "news" && (bd.policy >= 50 || bd.impact >= 50)) matchesHeuristic = true;
          }
          if (!hasTag && !matchesHeuristic) return false;
        }

        // 2. Text Filter
        if (!q) return true;
        const hay = [
          it.title || "",
          it.source || "",
          it.resume_fr || "",
          it.summary_fr || "",
          (it.tags || []).join(" ")
        ].join(" ").toLowerCase();
        return hay.includes(q);
      });
    }

    function groupByDay(items) {
      const map = new Map();
      for (const it of items) {
        const d = it.published ? new Date(it.published) : null;
        const key = d ? d.toISOString().slice(0, 10) : "inconnue";
        if (!map.has(key)) map.set(key, []);
        map.get(key).push(it);
      }
      const days = Array.from(map.keys()).sort((a, b) => b.localeCompare(a));
      return { map, days };
    }

    function pagerLinks(totalPages, current, qs, prevLabel = "◀ Page préc.", nextLabel = "Page suiv. ▶") {
      const links = [];
      if (current > 1) {
        const u = new URL(location.href);
        const p = new URLSearchParams(qs);
        p.set("view", VIEW);
        if (VIEW === "pages") p.set("p", String(current - 1));
        if (VIEW === "days") p.set("d", String(current - 1));
        u.search = p.toString();
        links.push(`<a href="${u.toString()}" rel="prev">${prevLabel}</a>`);
      } else {
        links.push(`<span class="muted">${prevLabel}</span>`);
      }
      links.push(`<span class="current">Page ${current}/${totalPages}</span>`);
      if (current < totalPages) {
        const u = new URL(location.href);
        const p = new URLSearchParams(qs);
        p.set("view", VIEW);
        if (VIEW === "pages") p.set("p", String(current + 1));
        if (VIEW === "days") p.set("d", String(current + 1));
        u.search = p.toString();
        links.push(`<a href="${u.toString()}" rel="next">${nextLabel}</a>`);
      } else {
        links.push(`<span class="muted">${nextLabel}</span>`);
      }
      return links.join(" ");
    }

    function buildQS(extra = {}) {
      const p = new URLSearchParams();
      p.set("view", VIEW);
      p.set("n", PAGE_SIZE);
      p.set("profile", profileSel.value);
      p.set("t", THRESH);
      p.set("cw", USE_CUSTOM ? "1" : "0");
      p.set("w", currentWeights().join(","));
      p.set("preview", PREVIEW ? "1" : "0");
      const FILTER = (qInput.value || "").trim();
      if (FILTER) p.set("q", FILTER);
      if (VIEW === "pages") p.set("p", PAGE);
      if (VIEW === "days") p.set("d", DAY_INDEX);
      for (const [k, v] of Object.entries(extra)) {
        if (v == null) continue;
        p.set(k, v);
      }
      return p.toString();
    }

    function weightsLabel() {
      const [r, p, i, m] = currentWeights();
      return `Poids (normés) R/P/I/M: ${r}/${p}/${i}/${m}`;
    }

    function render() {
      const itemsAll = filterItems(DATA?.items || []);
      const total = itemsAll.length;

      stamp.textContent =
        `Généré le ${new Date(DATA.generatedAt).toLocaleString()}. ` +
        `${DATA.totalPublished ?? total} sélection(s).` +
        ` • profil: ${DATA.profile}` +
        ` • seuil: ${THRESH}` +
        ` • ${weightsLabel()}` +
        ` • mode: ${PREVIEW ? "preview" : "global"}` +
        (showMeta.checked && DATA.debug?.analysisFailed ? " • OpenAI indisponible" : "");

      grid.innerHTML = "";
      pager.innerHTML = "";

      if (VIEW === "pages") {
        const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
        if (PAGE > pages) PAGE = pages;
        const start = (PAGE - 1) * PAGE_SIZE;
        renderSlice(itemsAll.slice(start, start + PAGE_SIZE));
        const qs = buildQS({ p: undefined });
        pager.innerHTML = pagerLinks(pages, PAGE, qs);
      } else {
        const { map, days } = groupByDay(itemsAll);
        const dPages = Math.max(1, days.length);
        if (DAY_INDEX > dPages) DAY_INDEX = dPages;
        const dayKey = days[DAY_INDEX - 1];
        renderSlice(map.get(dayKey) || []);
        const qs = buildQS({ d: undefined });
        pager.innerHTML = pagerLinks(dPages, DAY_INDEX, qs, "◀ Jour préc.", "Jour suiv. ▶");
      }
    }

    function renderSlice(slice) {
      if (!slice.length) {
        grid.innerHTML = "<p class='muted'>Aucune actualité pour ces critères.</p>";
        return;
      }
      slice.forEach(it => {
        const tpl = document.getElementById("card-tpl").content.cloneNode(true);
        const img = tpl.querySelector(".thumb");
        try {
          const h = new URL(it.url).hostname;
          const fallback = `https://www.google.com/s2/favicons?domain=${encodeURIComponent(h)}&sz=128`;
          img.src = toHttps(it.image || fallback);
        } catch { img.src = toHttps(it.image || ""); }
        img.alt = it.source ? `Image — ${it.source}` : "Image";

        const a = document.createElement("a");
        a.href = it.url; a.target = "_blank"; a.rel = "noopener"; a.textContent = it.title;
        tpl.querySelector(".t").appendChild(a);

        const d = it.published ? new Date(it.published) : null;

        const personal = it._userScore ?? it.score;
        let meta = `${it.source || "—"}${d ? " • " + d.toLocaleDateString() : ""} • score ${personal}`;
        if (showMeta.checked && typeof it.score === "number" && it.score !== personal) {
          meta += ` (feed ${it.score})`;
        }
        if (showMeta.checked) {
          const bd = it.breakdown || {};
          meta += ` • R/P/I/M: ${(bd.research | 0)}/${(bd.policy | 0)}/${(bd.institution | 0)}/${(bd.impact | 0)}`;
        }
        tpl.querySelector(".meta").textContent = meta;

        const summaryFr =
          it.summary_fr ||      // nouveau champ FR dédié
          it.resume_fr ||       // compat ancienne version du feed
          it.summary_en ||      // fallback EN si vraiment rien
          "";

        tpl.querySelector(".r").textContent = summaryFr;
        tpl.querySelector(".tags").innerHTML = (it.tags || []).map(t => `<span class="tag">${t}</span>`).join(" ");
        tpl.querySelector(".reason").textContent = showMeta.checked && it.reason ? it.reason : "";
        grid.appendChild(tpl);
      });
    }

    // --------- UI events ---------

    // Actualiser -> overlay + reload du flux
    refreshBtn.addEventListener("click", async () => {
      try {
        showOverlay("Actualisation du flux…", 25);
        await load();
        showOverlay("Flux mis à jour ✔", 100);
      } catch (e) {
        showOverlay("Erreur lors de l'actualisation : " + (e.message || e), 100);
      } finally {
        setTimeout(hideOverlay, 1200);
      }
    });

    showMeta.addEventListener("change", render);

    pageSizeSel.addEventListener("change", () => {
      PAGE_SIZE = clampInt(pageSizeSel.value, 5, 100);
      params.set("n", String(PAGE_SIZE));
      if (VIEW === "pages") params.set("p", "1");
      url.search = params.toString(); location.href = url.toString();
    });

    qInput.addEventListener("change", () => {
      params.set("q", qInput.value || "");
      params.set(VIEW === "pages" ? "p" : "d", "1");
      url.search = params.toString(); location.href = url.toString();
    });

    catFilter.addEventListener("change", render);

    profileSel.addEventListener("change", () => {
      const p = profileSel.value;
      localStorage.setItem("newsProfile", p);
      RAW_W = readCustomRaw(p) || DEFAULT_W[p];
      USE_CUSTOM = readCustomEnabled(p);
      useCustom.checked = USE_CUSTOM;
      [wR, wP, wI, wM].forEach((el, i) => el.value = String(RAW_W[i] || 0));
      updateWeightsLabels();
      params.set("profile", p);
      params.set("p", "1");
      url.search = params.toString(); location.href = url.toString();
    });

    [wR, wP, wI, wM].forEach(el => {
      el.addEventListener("input", () => {
        RAW_W = [wR, wP, wI, wM].map(x => clampInt(x.value, 0, 100));
        updateWeightsLabels();
      });
    });

    useCustom.addEventListener("change", () => {
      USE_CUSTOM = useCustom.checked;
      const p = profileSel.value;
      localStorage.setItem(customKey(p), RAW_W.join(","));
      localStorage.setItem(customFlagKey(p), USE_CUSTOM ? "1" : "0");
      updateWeightsLabels();
      render();
    });

    viewPagesBtn.addEventListener("click", e => {
      e.preventDefault();
      VIEW = "pages";
      params.set("view", VIEW);
      params.set("p", "1");
      params.delete("d");
      url.search = params.toString(); location.href = url.toString();
    });

    viewDaysBtn.addEventListener("click", e => {
      e.preventDefault();
      VIEW = "days";
      params.set("view", VIEW);
      params.set("d", "1");
      params.delete("p");
      url.search = params.toString(); location.href = url.toString();
    });

    previewModeChk.addEventListener("change", () => {
      PREVIEW = previewModeChk.checked;
      params.set("preview", PREVIEW ? "1" : "0");
      url.search = params.toString(); location.href = url.toString();
    });

    buildBtn.addEventListener("click", async () => {
      try {
        showOverlay("Création du run GitHub Actions…", 10);
        const [r, p, i, m] = currentWeights();
        const body = {
          profile: profileSel.value,
          score_min: THRESH,
          output_cap: PAGE_SIZE,
          use_openai: true,
          custom_weights: `${r},${p},${i},${m}`,
          preview: PREVIEW ? "true" : "false"
        };
        const r2 = await fetch("/api/trigger-news", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        const j = await r2.json();
        if (!r2.ok || !j.ok) throw new Error(j.error || "Échec de la création du run");

        const key = j.run_key;
        await pollRun(key);
        await load();
        hideOverlay();
      } catch (e) {
        showOverlay("Erreur: " + (e.message || e), 100);
        setTimeout(hideOverlay, 4000);
      }
    });

    function showOverlay(txt, pct) {
      overlay.style.display = "flex";
      ovlStatus.textContent = txt || "";
      ovlBar.style.width = (pct || 0) + "%";
    }
    function hideOverlay() { overlay.style.display = "none"; }

    async function pollRun(key) {
      let pct = 20;
      showOverlay("Run créé, en attente du runner…", pct);
      const start = Date.now();

      while (true) {
        await new Promise(r => setTimeout(r, 4000));

        const r = await fetch(`/api/check-news?run_key=${encodeURIComponent(key)}`, { cache: "no-store" });
        const j = await r.json();
        if (!j.found) {
          pct = Math.min(50, pct + 5);
          showOverlay("Run en file d'attente…", pct);
          continue;
        }
        if (j.status === "queued") {
          pct = Math.min(60, pct + 5);
          showOverlay("Queued…", pct);
          continue;
        }
        if (j.status === "in_progress") {
          pct = Math.min(90, 60 + Math.floor((Date.now() - start) / 15000));
          showOverlay("En cours d'exécution…", pct);
          continue;
        }
        if (j.status === "completed") {
          if (j.conclusion === "success") {
            showOverlay("Terminé ✔ — actualisation du flux…", 100);
          } else {
            throw new Error("Run terminé avec l'état: " + j.conclusion);
          }
          break;
        }
      }
    }

    function updateWeightsLabels() {
      const [r, p, i, m] = currentWeights();
      weightsSum.textContent = `Poids (normés) R/P/I/M: ${r}/${p}/${i}/${m}`;
      wRVal.textContent = r; wPVal.textContent = p; wIVal.textContent = i; wMVal.textContent = m;
    }

    async function load() {
      try {
        const urls = makeUrls(profileSel.value);
        const data = await fetchFirstOk(urls);
        DATA = data;
        THRESH = clampInt(data.threshold ?? THRESH, 0, 100);
        document.getElementById("th").value = String(THRESH);
        document.getElementById("thVal").textContent = String(THRESH);
        updateLabelsExplain();
        render();
      } catch (e) {
        grid.innerHTML = `<p class="muted">Erreur de chargement: ${e.message || e}</p>`;
        pager.innerHTML = "";
      }
    }

    document.getElementById("th").addEventListener("input", e => {
      THRESH = clampInt(e.target.value, 0, 100);
      document.getElementById("thVal").textContent = String(THRESH);
      render();
    });

    // ---------- Start ----------
    load();
  </script>
</body>

</html>