<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nicolas Tuor — Passions & découvertes</title>

  <!-- UPDATE: hreflang -->
  <link rel="alternate" hreflang="fr" href="/passions.html">
  <link rel="alternate" hreflang="en" href="/passions-en.html">
  <link rel="alternate" hreflang="de" href="/passions-de.html">
  <link rel="alternate" hreflang="x-default" href="/passions.html">

  <link rel="icon" href="favicon.ico">
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <meta name="theme-color" content="#0a1220" />

  <style>
    :root{
      --bg:#0a1220; --card:#0c1628; --text:#eef3f8; --muted:#a7b7cb; --accent:#14b8a6;
      --shadow:0 10px 30px rgba(0,0,0,.35); --br:16px; --gap:16px; --max:1200px;
    }
    *{box-sizing:border-box} html,body{height:100%} html{scroll-behavior:smooth}
    body{margin:0;color:var(--text);background: radial-gradient(1200px 700px at 20% 0%, #0b1930 0%, var(--bg) 55%) fixed;
         font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;}

    header{position:sticky;top:0;z-index:20;background:rgba(10,18,32,.7);backdrop-filter:blur(6px);
           border-bottom:1px solid rgba(255,255,255,.06)}
    .headwrap{max-width:var(--max);margin:0 auto;padding:12px 18px;display:flex;gap:12px;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:.75rem;align-items:center;font-weight:800;letter-spacing:.3px}
    .logo{width:32px;height:32px;border-radius:9px;display:grid;place-items:center;background:linear-gradient(135deg,#0a1220,#00060d);
          color:#fff;border:1px solid rgba(255,255,255,.08);box-shadow:inset 0 0 0 1px rgba(255,255,255,.04)}

    nav.top{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
    .btn{appearance:none;border:1px solid rgba(255,255,255,.08);background:#0c1728;color:var(--text);text-decoration:none;
         padding:.45rem .7rem;border-radius:10px;font-weight:600;font-size:14px}
    .btn:hover{background:#0e1b2f}.btn:active{transform:translateY(1px)}

    /* Lang switch */
    .langs{display:flex;gap:6px;margin-left:8px}
    .lang{border:1px solid rgba(255,255,255,.12);background:#0f1d34;color:var(--text);text-decoration:none;
          padding:.35rem .55rem;border-radius:8px;font-weight:700;font-size:12px;opacity:.9}
    .lang[aria-current="page"]{background:#143055;border-color:#2a4d77;opacity:1}

    .bar{border-top:1px solid rgba(255,255,255,.06);border-bottom:1px solid rgba(255,255,255,.06);background:rgba(10,18,32,.55)}
    .barwrap{max-width:var(--max);margin:0 auto;padding:10px 18px;display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:.4rem .7rem;border-radius:999px;background:#0f1d34;border:1px solid #1a2d49;color:var(--text);
          text-decoration:none;font-weight:600;font-size:14px}
    .chip:hover{background:#10223a}

    main{max-width:var(--max);margin:0 auto;padding:24px 18px 80px}
    h1{margin:10px 0 6px 0;font-size:28px} p.lead{margin:0 0 22px 0;color:var(--muted)}
    section{margin:28px 0 8px 0} section>h2{margin:18px 6px 4px 6px;font-size:22px}
    section>p.catdesc{margin:0 6px 14px 6px;color:var(--muted)}

    .grid{display:grid;gap:var(--gap);grid-template-columns:repeat(3,1fr)}
    @media (max-width:980px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:620px){.grid{grid-template-columns:1fr}}

    .card{background:linear-gradient(180deg, rgba(255,255,255,.02), transparent);
          border:1px solid rgba(255,255,255,.07);border-radius:var(--br);overflow:hidden;box-shadow:var(--shadow);
          display:flex;flex-direction:column;min-height:320px}
    .thumb{position:relative;height:180px;background:#0d1524;background-size:cover;background-position:center;border-bottom:1px solid rgba(255,255,255,.07)}
    .thumb::after{content:"";position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,0) 40%,rgba(0,0,0,.25))}
    .badge{position:absolute;left:10px;bottom:10px;background:rgba(10,18,32,.8);border:1px solid rgba(255,255,255,.1);
           color:var(--text);font-size:12px;padding:.25rem .5rem;border-radius:8px;backdrop-filter:blur(4px)}
    .body{padding:12px}.title{font-weight:800;margin:.2rem 0 .35rem 0;font-size:18px}.desc{margin:0;color:var(--muted)}
    .links{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .link{text-decoration:none;color:var(--text);background:#0c1728;border:1px solid rgba(255,255,255,.08);
          padding:.35rem .6rem;border-radius:10px;font-weight:600;font-size:14px}
    .link:hover{background:#0e1b2f}
    .thumb[data-cover]{background-image:linear-gradient(180deg,#0d1524,#0a1220)}
    .thumb.loaded{background-image:var(--img)}

    /* === Cartes Jeux Osselets === */
    .game-card{background:linear-gradient(180deg, rgba(255,255,255,.02), transparent);
      border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:12px; box-shadow:var(--shadow); margin:18px 6px}
    .game-head{display:flex;align-items:center;justify-content:space-between; gap:8px; padding:4px 6px 10px 6px}
    .game-actions{display:flex; gap:8px}
    .game-btn{padding:.45rem .7rem; border:1px solid #2563eb; background:#2563eb; color:#fff; border-radius:10px; font-weight:700; cursor:pointer}
    .game-btn.alt{border-color:#334155; background:#0c1728}
    .game-pane{position:relative; width:100%; aspect-ratio:16/9; max-height:560px; border:1px solid rgba(255,255,255,.07);
      border-radius:12px; overflow:hidden; background:#0b1625}
    .game-foot{font-size:12px; color:#95a3b6; margin-top:6px}
  </style>

  <link rel="stylesheet" href="/style.css">
  <script defer src="/assets/js/nav.js"></script>
  <script defer src="/assets/js/feedback.js"></script>

  <!-- Three.js UMD + add-ons (doc officielle "examples/js/...") -->
  <script defer src="https://unpkg.com/three@0.155.0/build/three.min.js"></script>
  <script defer src="https://unpkg.com/three@0.155.0/examples/js/controls/OrbitControls.js"></script>
  <script defer src="https://unpkg.com/three@0.155.0/examples/js/loaders/GLTFLoader.js"></script>
</head>
<body>
<header>
  <div class="headwrap">
    <div class="brand"><div class="logo">N·T</div><div>Passions & découvertes</div></div>
    <!-- UPDATE: NAV LAYOUT ONLY -->
    <nav class="site-nav" aria-label="Navigation">
      <ul class="menu">
        <li><a class="btn" href="/index.html">Accueil</a></li>
        <li><a class="btn" href="/cv.html">CV</a></li>
        <li><a class="btn" href="/portfolio.html">Portfolio</a></li>
        <li><a class="btn" href="/passions.html" aria-current="page">Passions</a></li>
        <li><a class="btn" href="/ai-lab.html">Labo IA</a></li>
        <li><a class="btn" href="/fun-facts.html">Idées reçues</a></li>
      </ul>
      <ul class="lang" aria-label="Langues">
        <li><a class="lang" href="/passions.html" aria-current="page">FR</a></li>
        <li><a class="lang" href="/passions-en.html">EN</a></li>
        <li><a class="lang" href="/passions-de.html">DE</a></li>
      </ul>
    </nav>
  </div>
  <div class="bar">
    <div class="barwrap">
      <a class="chip" href="#astronomie">Astronomie</a>
      <a class="chip" href="#diy">DIY & Bricolage</a>
      <a class="chip" href="#histoire">Histoire & Savoirs</a>
      <a class="chip" href="#esprit">Esprit critique</a>
      <a class="chip" href="#cuisine">Cuisine</a>
      <a class="chip" href="#edunum">Éducation numérique</a>
      <a class="chip" href="#outils">Outils & divers</a>
      <a class="chip" href="#jeux">Jeux vidéo</a>
      <a class="chip" href="#osselets">Osselets</a>
    </div>
  </div>
</header>

<main>
  <h1>Mes passions & ressources</h1>
  <p class="lead">Sélection de chaînes, sites et outils. Descriptions concises, images locales pour un chargement rapide.</p>

  <section id="astronomie">
    <h2>Astronomie</h2>
    <p class="catdesc">Imagerie, données ouvertes et ressources pour observer, comprendre et bricoler.</p>
    <div class="grid" id="grid-astro"></div>
  </section>

  <section id="diy">
    <h2>DIY & Bricolage</h2>
    <p class="catdesc">Construire, réparer, comprendre la matière et les mécanismes.</p>
    <div class="grid" id="grid-diy"></div>
  </section>

  <section id="histoire">
    <h2>Histoire & Savoirs</h2>
    <p class="catdesc">Chaînes et docs pour comprendre technologies et histoire avec rigueur.</p>
    <div class="grid" id="grid-hist"></div>
  </section>

  <section id="esprit">
    <h2>Esprit critique</h2>
    <p class="catdesc">Analyses, méthodes et enquêtes pour mieux raisonner.</p>
    <div class="grid" id="grid-crit"></div>
  </section>

  <section id="cuisine">
    <h2>Cuisine & Food</h2>
    <p class="catdesc">Techniques, sources historiques, recettes actionnables.</p>
    <div class="grid" id="grid-food"></div>
  </section>

  <section id="edunum">
    <h2>Éducation numérique</h2>
    <p class="catdesc">Coder, simuler, apprendre en jouant — outils et environnements pour tous.</p>
    <div class="grid" id="grid-edu"></div>
  </section>

  <section id="outils">
    <h2>Outils & divers</h2>
    <p class="catdesc">IA, images, audio, données ouvertes, culture scientifique & curiosités.</p>
    <div class="grid" id="grid-tools"></div>
  </section>

  <section id="jeux">
    <h2>Jeux vidéo</h2>
    <p class="catdesc">Top 40 Steam (images locales) + sélection hors-Steam.</p>

    <h3 style="margin:6px 6px 10px 6px">Top 40 Steam</h3>
    <div class="grid" id="grid-steam"></div>

    <div style="height:1px;background:rgba(255,255,255,.06);margin:20px 0"></div>

    <h3 style="margin:6px 6px 10px 6px">Sélection hors-Steam</h3>
    <div class="grid" id="grid-games-custom"></div>
  </section>

  <!-- ========= NOUVELLE SECTION : OSSELETS ========= -->
  <section id="osselets">
    <h2>Osselets — mini-jeux 3D</h2>
    <p class="catdesc">Expériences pédagogiques en Three.js. Clique <strong>Lancer</strong> pour démarrer.</p>

    <!-- Level 2 -->
    <div class="game-card">
      <div class="game-head">
        <div class="title">Écrire avec les os — Fil & alphabet</div>
        <div class="game-actions">
          <button class="game-btn" onclick="startOsseletsLevel2('#l2-box')">Lancer</button>
        </div>
      </div>
      <div id="l2-box" class="game-pane"></div>
      <div class="game-foot">Modèle : <code>/assets/games/osselets/level2/3d/astragalus.glb</code> — Étiquettes via <code>letters.json</code>.</div>
    </div>

    <!-- Level 3 -->
    <div class="game-card">
      <div class="game-head">
        <div class="title">Rouler les os — Vénus, Canis, Senio…</div>
        <div class="game-actions">
          <button class="game-btn" onclick="(window.__g3 = startOsseletsLevel3('#l3-box'))">Lancer</button>
          <button class="game-btn alt" onclick="window.__g3 && window.__g3.launch()">Relancer</button>
        </div>
      </div>
      <div id="l3-box" class="game-pane"></div>
      <div class="game-foot">Modèle : <code>/assets/games/osselets/level3/3d/astragalus_faces.glb</code> — Score par lecture des faces 1/3/4/6.</div>
    </div>
  </section>
</main>

<!-- ====== TES SCRIPTS EXISTANTS (grilles) ====== -->
<script>
  const open = (url)=>window.open(url,'_blank','noopener');

  /* ==== Données ==== */
  const ASTRO = [ /* … inchangé … */ ];
  const DIY = [ /* … inchangé … */ ];
  const HIST = [ /* … inchangé … */ ];
  const CRIT = [ /* … inchangé … */ ];
  const FOOD = [ /* … inchangé … */ ];
  const EDU = [ /* … inchangé … */ ];
  const TOOLS = [ /* … inchangé … */ ];
  const GAMES_CUSTOM = [ /* … inchangé … */ ];

  /* ==== Helpers ==== */
  function card({title, desc, cover, badge, link, links}) {
    const el = document.createElement('article');
    el.className = 'card';
    el.innerHTML = `
      <div class="thumb" data-cover="${cover || ''}"><span class="badge">${badge || ''}</span></div>
      <div class="body">
        <div class="title">${escapeHtml(title)}</div>
        ${desc ? `<p class="desc">${escapeHtml(desc)}</p>` : ''}
        <div class="links"></div>
      </div>`;
    const wrap = el.querySelector('.links');
    if (link) wrap.appendChild(chip(link.label, link.href));
    if (Array.isArray(links)) links.forEach(l => wrap.appendChild(chip(l.label, l.href)));
    return el;
  }
  function chip(label, href){
    const a = document.createElement('a'); a.className='link'; a.textContent=label; a.href=href; a.target='_blank'; a.rel='noopener'; return a;
  }
  function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}
  function renderList(list, id){const root=document.getElementById(id); list.forEach(x=>root.appendChild(card(x)));}

  /* ==== Steam Top 40 ==== */
  async function renderSteam(){
    const root = document.getElementById('grid-steam');
    try{
      const res = await fetch('data/steam-top40.json', {cache:'no-cache'});
      if(!res.ok) throw new Error('steam-top40.json introuvable');
      const data = await res.json();
      data.forEach(g=>{
        const appid = g.appid || g.id || g.appId;
        const cover = appid ? `assets/passions/games/steam/${appid}.webp` : '';
        const store = appid
          ? `https://store.steampowered.com/app/${appid}/`
          : `https://store.steampowered.com/search/?term=${encodeURIComponent(g.name||'')}`;
        const el = card({ title:g.name, desc:"", cover, badge:"Steam", link:{label:"Fiche",href:store} });
        root.appendChild(el);
        const t = el.querySelector('.thumb'); if (t) io.observe(t);
      });
      observeThumbs();
    }catch(e){
      const d = document.createElement('div');
      d.className = 'desc'; d.style.margin='6px';
      d.textContent = "Impossible de charger le Top 40. Vérifie data/steam-top40.json et les images sous assets/passions/games/steam/ .";
      root.before(d);
      console.warn(e);
    }
  }

  /* ==== Lazy load covers ==== */
  const io = new IntersectionObserver((entries)=>{
    entries.forEach(e=>{
      if(!e.isIntersecting) return;
      const t = e.target;
      const url = t.getAttribute('data-cover');
      if(url){ preloadCover(url).then(ok=>{
        if(ok) setThumbBackground(t,url);
        else console.warn('Cover introuvable:', url);
        t.classList.add('loaded'); t.removeAttribute('data-cover');
      }); }
      io.unobserve(t);
    });
  }, { rootMargin:'400px' });

  function setThumbBackground(el,url){ el.style.setProperty('--img', `url("${url}")`); }
  function preloadCover(url){ return new Promise(res=>{ const i=new Image(); i.onload=()=>res(true); i.onerror=()=>res(false); i.src=url; }); }
  function observeThumbs(){ document.querySelectorAll('.thumb[data-cover]').forEach(el=>io.observe(el)); }

  /* ==== Init ==== */
  renderList(ASTRO,'grid-astro');
  renderList(DIY,'grid-diy');
  renderList(HIST,'grid-hist');
  renderList(CRIT,'grid-crit');
  renderList(FOOD,'grid-food');
  renderList(EDU,'grid-edu');
  renderList(TOOLS,'grid-tools');
  renderList(GAMES_CUSTOM,'grid-games-custom');
  renderSteam();
  (function waitThenObserve(){ if(document.readyState==='complete') return observeThumbs();
    window.addEventListener('load', observeThumbs, {once:true}); })();
</script>

<!-- ====== LEVEL 2 (inline, plain JS) ====== -->
<script>
(function () {
  var MODEL_URL   = "/assets/games/osselets/level2/3d/astragalus.glb";
  var LETTERS_URL = "/assets/games/osselets/level2/3d/letters.json";

  function makeLabelSprite(char) {
    var size = 128, cvs = document.createElement("canvas"); cvs.width = cvs.height = size;
    var ctx = cvs.getContext("2d");
    ctx.fillStyle = "#0ea5e9"; ctx.beginPath(); ctx.arc(size/2, size/2, size*0.40, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = "#fff"; ctx.font = "bold " + Math.round(size*0.42) + "px ui-sans-serif,system-ui";
    ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillText(char, size/2, size/2);
    var tex = new THREE.CanvasTexture(cvs); tex.anisotropy = 4;
    var mat = new THREE.SpriteMaterial({ map: tex, depthTest: true, depthWrite: false, transparent: true });
    var sp = new THREE.Sprite(mat); sp.scale.set(6,6,6); return sp;
  }
  function fitToParent(renderer, camera, container) {
    var w = container.clientWidth || 640, h = container.clientHeight || 360;
    renderer.setPixelRatio(Math.min(2, window.devicePixelRatio || 1));
    renderer.setSize(w, h, false); camera.aspect = w / h; camera.updateProjectionMatrix();
  }
  function createL2(container) {
    var scene = new THREE.Scene(); scene.background = new THREE.Color(0x0d1b2a);
    var camera = new THREE.PerspectiveCamera(45, 1, 0.1, 1000); camera.position.set(0, 16, 30);
    var renderer = new THREE.WebGLRenderer({ antialias: true }); renderer.outputColorSpace = THREE.SRGBColorSpace;
    container.innerHTML = ""; container.appendChild(renderer.domElement);
    var controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true; controls.minDistance=12; controls.maxDistance=60; controls.target.set(0,6,0);
    var ground = new THREE.Mesh(new THREE.PlaneGeometry(200,200), new THREE.MeshPhongMaterial({ color: 0x36526b }));
    ground.rotation.x=-Math.PI/2; scene.add(ground);
    scene.add(new THREE.AmbientLight(0xffffff, .65)); var dir = new THREE.DirectionalLight(0xffffff,.85); dir.position.set(12,18,10); scene.add(dir);

    var loading = document.createElement("div"); loading.style.position="absolute"; loading.style.left="50%"; loading.style.top="50%";
    loading.style.transform="translate(-50%,-50%)"; loading.style.color="#f1f5f9"; loading.style.font="14px ui-sans-serif,system-ui";
    loading.textContent="Chargement…"; container.style.position="relative"; container.appendChild(loading);

    var modelRoot=null, labelSprites=[];
    function addLabels(root, letters){
      var nodes=[]; root.traverse(function(o){ if(o.name && o.name.toLowerCase().indexOf("hole")===0) nodes.push(o); });
      var n = Math.min(nodes.length, letters.length), tmp=new THREE.Vector3();
      for(var i=0;i<n;i++){ var sp=makeLabelSprite(letters[i]); nodes[i].getWorldPosition(tmp); sp.position.copy(tmp).add(new THREE.Vector3(0,0.3,0)); scene.add(sp); labelSprites.push(sp); }
    }
    function loadAll(){
      if(!THREE || !THREE.GLTFLoader){ loading.textContent="GLTFLoader manquant"; return; }
      var letters=[]; fetch(LETTERS_URL,{cache:"no-store"}).then(r=>r.ok?r.json():[]).then(j=>{ letters=Array.isArray(j)?j:[]; }).finally(function(){
        var loader=new THREE.GLTFLoader();
        loader.load(MODEL_URL, function(gltf){
          if(modelRoot) scene.remove(modelRoot);
          modelRoot=gltf.scene||gltf.scenes[0]; modelRoot.position.set(0,6,0);
          modelRoot.traverse(function(o){ if(o.isMesh){ o.material.depthTest=true; o.material.depthWrite=true; } });
          scene.add(modelRoot);
          labelSprites.forEach(s=>scene.remove(s)); labelSprites.length=0;
          if(letters.length) addLabels(modelRoot, letters);
          loading.remove();
        }, undefined, function(err){ loading.textContent="Échec GLB"; console.warn("[L2] glb error", err); });
      });
    }
    function loop(){ requestAnimationFrame(loop); controls.update(); renderer.render(scene,camera); }
    function resize(){ fitToParent(renderer,camera,container); }
    var ro=new ResizeObserver(resize); ro.observe(container); window.addEventListener("resize",resize); resize();
    loadAll(); loop();
    return { destroy:function(){ try{ro.disconnect();}catch(e){} window.removeEventListener("resize",resize); container.innerHTML=""; } };
  }
  window.startOsseletsLevel2 = function (target) {
    var el = typeof target==="string" ? document.querySelector(target) : target;
    if(!el) return; if(el.__l2) el.__l2.destroy(); el.__l2 = createL2(el);
  };
})();
</script>

<!-- ====== LEVEL 3 (inline, plain JS) ====== -->
<script>
(function () {
  var MODEL_URL = "/assets/games/osselets/level3/3d/astragalus_faces.glb";

  function fit(r,c,box){ var w=box.clientWidth||640,h=box.clientHeight||360; r.setPixelRatio(Math.min(2,window.devicePixelRatio||1)); r.setSize(w,h,false); c.aspect=w/h; c.updateProjectionMatrix(); }
  function choose(a){ return a[(Math.random()*a.length)|0]; }

  function createL3(container){
    var scene=new THREE.Scene(); scene.background=new THREE.Color(0xf5f7fb);
    var camera=new THREE.PerspectiveCamera(45,1,.1,1000); camera.position.set(0,26,46);
    var renderer=new THREE.WebGLRenderer({antialias:true}); renderer.outputColorSpace=THREE.SRGBColorSpace;
    container.innerHTML=""; container.appendChild(renderer.domElement);
    var controls=new THREE.OrbitControls(camera,renderer.domElement); controls.enableDamping=true; controls.minDistance=18; controls.maxDistance=80; controls.target.set(0,6,0);
    var ground=new THREE.Mesh(new THREE.CircleGeometry(120,64), new THREE.MeshPhongMaterial({color:0xe2e8f0})); ground.rotation.x=-Math.PI/2; scene.add(ground);
    scene.add(new THREE.AmbientLight(0xffffff,.7)); var d=new THREE.DirectionalLight(0xffffff,.9); d.position.set(20,30,12); scene.add(d);

    var scoreDiv=document.createElement("div"); scoreDiv.style.position="absolute"; scoreDiv.style.right="12px"; scoreDiv.style.top="10px";
    scoreDiv.style.background="#1f2937"; scoreDiv.style.color="#fff"; scoreDiv.style.padding="6px 10px"; scoreDiv.style.borderRadius="10px"; scoreDiv.style.font="14px ui-sans-serif,system-ui";
    scoreDiv.textContent="Score : —"; container.style.position="relative"; container.appendChild(scoreDiv);

    var loading=document.createElement("div"); loading.style.position="absolute"; loading.style.left="50%"; loading.style.top="50%";
    loading.style.transform="translate(-50%,-50%)"; loading.style.color="#475569"; loading.style.font="14px ui-sans-serif,system-ui"; loading.textContent="Chargement du modèle 3D…";
    container.appendChild(loading);

    var singleDie=null, dice=[];
    var names=["face_1","face_3","face_4","face_6"];
    function findAnchors(root){ var out={}; root.traverse(function(o){ if(!o.name)return; var n=o.name.toLowerCase().replace(/\s+/g,""); for(var i=0;i<names.length;i++){ var k=names[i]; if(n.indexOf(k)===0||n.indexOf("anchor_"+k)===0){ out[k.split("_")[1]]=o; } } }); return out; }
    function cloneDie(){ var root=singleDie.clone(true); scene.add(root); return {root:root, vel:new THREE.Vector3(), targetQuat:new THREE.Quaternion(), anchors:findAnchors(root), settled:false, value:0}; }

    function loadModel(cb){
      if(!THREE || !THREE.GLTFLoader){ loading.textContent="GLTFLoader manquant"; return; }
      var loader=new THREE.GLTFLoader();
      loader.load(MODEL_URL, function(gltf){ singleDie=gltf.scene||gltf.scenes[0];
        singleDie.traverse(function(o){ if(o.isMesh){ o.material.depthTest=true; o.material.depthWrite=true; }});
        loading.remove(); if(cb)cb();
      }, undefined, function(e){ loading.textContent="Échec GLB"; console.warn("[L3] glb error",e); });
    }

    var up=new THREE.Vector3(0,1,0), tmpQ=new THREE.Quaternion();
    function pickTopFace(d){ var best={dot:-1,val:0}; for(var k in d.anchors){ var a=d.anchors[k]; a.updateWorldMatrix(true,false);
        var m=new THREE.Matrix4().extractRotation(a.matrixWorld); var y=new THREE.Vector3(0,1,0).applyMatrix4(m).normalize();
        var dot=y.dot(up); if(dot>best.dot){ best.dot=dot; best.val=parseInt(k,10);} } return best.val||0; }
    function quatToPutFaceUp(d, val){ var a=d.anchors[val]; if(!a) return d.root.quaternion.clone(); a.updateWorldMatrix(true,false);
      var qA=new THREE.Quaternion(); a.getWorldQuaternion(qA); var y=new THREE.Vector3(0,1,0).applyQuaternion(qA).normalize();
      var qFix=new THREE.Quaternion().setFromUnitVectors(y, up); var qDie=new THREE.Quaternion(); d.root.getWorldQuaternion(qDie); return qFix.multiply(qDie); }
    function separate(){ for(var i=0;i<dice.length;i++){ for(var j=i+1;j<dice.length;j++){ var a=dice[i].root.position, b=dice[j].root.position;
          var dx=b.x-a.x, dz=b.z-a.z, dist2=dx*dx+dz*dz, min=6.0; if(dist2<(min*min)){ var d=Math.sqrt(dist2)||0.001, push=(min-d)*0.5, nx=dx/d, nz=dz/d; a.x-=nx*push; a.z-=nz*push; b.x+=nx*push; b.z+=nz*push; } } } }

    function launch(){
      dice.forEach(d=>scene.remove(d.root)); dice.length=0;
      for(var i=0;i<4;i++){ var d=cloneDie(); d.root.position.set(-15+i*10+(Math.random()*2-1), 8+Math.random()*2, -4+Math.random()*8);
        d.root.rotation.set(Math.random()*Math.PI,Math.random()*Math.PI,Math.random()*Math.PI);
        d.vel.set(2+Math.random()*5,0,2+Math.random()*5).multiplyScalar((Math.random()<.5)?1:-1);
        var v=choose([1,3,4,6]); d.targetQuat.copy(quatToPutFaceUp(d,v)); d.value=v; dice.push(d); }
      var settleT=0;
      function step(){
        var active=false;
        for(var i=0;i<dice.length;i++){ var di=dice[i];
          if(!di.settled){
            di.root.position.y=Math.max(6, di.root.position.y-0.6);
            di.root.position.addScaledVector(di.vel, 1/60); di.vel.multiplyScalar(0.98);
            tmpQ.copy(di.targetQuat); di.root.quaternion.slerp(tmpQ, 0.04);
            var ang=1-Math.abs(di.root.quaternion.dot(tmpQ)); if(ang<0.0008 && di.vel.lengthSq()<0.002) di.settled=true; else active=true;
          }
        }
        separate();
        if(!active){ settleT+=1/60; if(settleT>0.35){ var sum=0, faces=[]; for(var k=0;k<dice.length;k++){ var f=pickTopFace(dice[k])||dice[k].value; sum+=f; faces.push(f); }
            scoreDiv.textContent="Score : "+sum+"  (faces "+faces.join(", ")+")"; return; } }
        requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    function loop(){ requestAnimationFrame(loop); controls.update(); renderer.render(scene,camera); }
    function resize(){ fit(renderer,camera,container); }
    var ro=new ResizeObserver(resize); ro.observe(container); window.addEventListener("resize",resize); resize();
    loadModel(function(){ loop(); launch(); });

    return { launch:launch, destroy:function(){ try{ro.disconnect();}catch(e){} window.removeEventListener("resize",resize); container.innerHTML=""; } };
  }

  window.startOsseletsLevel3=function(target){
    var el=typeof target==="string"?document.querySelector(target):target; if(!el) return;
    if(el.__l3) el.__l3.destroy(); el.__l3=createL3(el); return el.__l3;
  };
})();
</script>
</body>
</html>
