// scripts/capture_site_covers.mjs
// Capture 1280x720 de pages web et vidéos, export .webp (qualité 82)
// Usage :  npm i puppeteer sharp fs-extra
//          node scripts/capture_site_covers.mjs
//          node scripts/capture_site_covers.mjs --force   (réécrit)

import fs from 'fs-extra';
import sharp from 'sharp';
import puppeteer from 'puppeteer';

const OUT_DIR = 'public/assets/passions/sites';
const FORCE = process.argv.includes('--force');
const VIEW = { width:1280, height:720, deviceScaleFactor:1 };
const QUALITY = 82;

const TARGETS = [
  { out:'armour-archive-patterns.webp', url:'https://www.armourarchive.org/patterns/' },
  { out:'art-of-making-things.webp',    url:'https://artofmakingthings.com/home' },
  { out:'sketchware-docs.webp',         url:'https://docs.sketchware.io/' },
  { out:'giza3d.webp',                  url:'http://giza.fas.harvard.edu/giza3d/' },

  // 4 vidéos DIY (une carte par vidéo)
  { out:'diy-clay-house.webp',          url:'https://youtu.be/o6Z0MxWCbrc' },
  { out:'diy-recycled-tv.webp',         url:'https://youtu.be/qXrn4MqY1Wo' },
  { out:'diy-ecosystems.webp',          url:'https://youtu.be/QTH9m6MDIfc' },
  { out:'diy-cloud-chamber.webp',       url:'https://youtu.be/xky3f1aSkB8' },
];

function skip(p){ return !FORCE && fs.existsSync(`${OUT_DIR}/${p}`); }

async function capture(page, url){
  await page.goto(url, { waitUntil:'networkidle2', timeout: 90000 });
  // ferme quelques bannières courantes si présentes
  try{
    await page.evaluate(()=>{
      const sels = [
        '#onetrust-accept-btn-handler',
        'button[aria-label*="Accept"]',
        'button[aria-label*="agree"]',
        'button.cookie-accept',
        'button#accept',
        'button[mode="primary"][data-accept="all"]'
      ];
      for(const s of sels){ const b=document.querySelector(s); if(b) b.click(); }
    });
  }catch{}
  await page.waitForTimeout(600);
  return await page.screenshot({ type:'png' });
}

async function run(){
  await fs.ensureDir(OUT_DIR);
  const browser = await puppeteer.launch({ headless:true, args:['--no-sandbox','--disable-gpu','--disable-dev-shm-usage'] });
  const page = await browser.newPage();
  await page.setViewport(VIEW);
  await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124 Safari/537.36');

  for(const t of TARGETS){
    const dst = `${OUT_DIR}/${t.out}`;
    if(skip(t.out)){ console.log('skip', t.out); continue; }
    try{
      const png = await capture(page, t.url);
      await sharp(png).resize(1280,720,{fit:'cover',position:'attention'}).webp({quality:QUALITY}).toFile(dst);
      console.log('saved', t.out);
      await page.waitForTimeout(150);
    }catch(e){
      console.warn('fail', t.out, e.message);
    }
  }
  await browser.close();
  console.log('\n✅ Captures prêtes dans', OUT_DIR);
}
run().catch(e=>{ console.error(e); process.exit(1); });
