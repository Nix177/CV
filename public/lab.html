<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Lab ‚Äî RAG Glassbox & Diff Explorer</title>
  <meta name="color-scheme" content="dark light">

  <!-- m√™me CSS global que le site -->
  <link rel="stylesheet" href="/style.css">

  <style>
    :root{
      --bg:#0a1220; --card:#0c1628; --muted:#9fb0c9; --text:#eef3f8; --acc:#63e; --ok:#2ecc71; --warn:#f39c12; --bad:#e74c3c;
      --border: #1a2a44;
    }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font:15px/1.5 ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;
    }
    /* on laisse nav.js injecter la nav globale ‚Äì on se met juste en dessous */
    .shell{
      max-width:1200px;
      margin:0 auto;
      padding:calc(var(--nt-nav-h, 64px) + 20px) 16px 40px;
    }

    header.page-head h1{margin:0 0 6px}
    header.page-head p{margin:0 0 16px;color:var(--muted)}

    .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:12px 0 20px}
    input,select,button,textarea{background:#0f1b30;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:8px 10px}
    input::placeholder,textarea::placeholder{color:#7e8aa3}
    button{cursor:pointer}
    button.primary{background:linear-gradient(90deg,#6c4bff,#4a74ff);border:none}
    .tabs{display:flex;gap:8px;margin:4px 0 16px}
    .tab{padding:8px 12px;border:1px solid var(--border);border-radius:999px;cursor:pointer;color:var(--muted)}
    .tab.active{background:#15223a;color:var(--text);border-color:#2b3b61}
    .panel{display:none}
    .panel.active{display:block}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin:10px 0}
    .grid{display:grid;gap:12px}
    .grid-2{grid-template-columns:1fr 1fr}
    @media (max-width:1000px){.grid-2{grid-template-columns:1fr}}
    .split{display:grid;grid-template-columns:1.1fr 1.4fr;gap:12px;min-height:520px}
    @media (max-width:1000px){.split{grid-template-columns:1fr}}
    .box{background:#0f1b30;border:1px solid var(--border);border-radius:12px;padding:12px;overflow:auto}
    .box h4{margin:0 0 8px}
    .timeline{font-family:ui-monospace,Consolas,monospace;font-size:13px;max-height:240px;overflow:auto}
    .tstep{padding:6px 8px;border-left:3px solid #2b3b61;margin:6px 0;background:#0f1b30;border-radius:8px}
    .tstep.ok{border-color:var(--ok)} .tstep.warn{border-color:var(--warn)} .tstep.bad{border-color:var(--bad)}
    .pill{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:2px 8px;margin:2px 4px 0 0;background:#13213a;color:#cfe0ff;font-size:12px}
    .score{height:10px;background:#0f1b30;border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .score > i{display:block;height:100%;background:linear-gradient(90deg,#ff5f6d,#ffc371)}
    .badges{display:flex;gap:8px;flex-wrap:wrap}
    .badge{padding:4px 8px;border-radius:8px;background:#14203a;border:1px solid var(--border)}
    .badge.ok{background:#0f2a1a;border-color:#245a3b}
    .badge.low{background:#2a1c0f;border-color:#5a3d24}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .mono{font-family:ui-monospace,Consolas,monospace}
    .diff{white-space:pre-wrap;font-family:ui-monospace,Consolas,monospace}
    .ins{background:#12371e} .del{background:#3a1520; text-decoration: line-through}
    .footer-note{color:#94a6c7;font-size:12px;margin-top:10px}
    details summary{cursor:pointer}
    .legend{background:#0f1b30;border:1px dashed #213356;border-radius:10px;padding:8px 10px;margin-top:10px}
  </style>

  <!-- pdf.js sans SRI -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
  <!-- diff-match-patch -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.min.js"></script>

  <!-- nav + feedback + site (analytics inject√© ici) -->
  <script defer src="/assets/js/nav.js"></script>
  <script defer src="/assets/js/feedback.js"></script>
  <script defer src="/assets/js/site.js"></script>
</head>
<body>

  <!-- le header r√©el sera reconstruit par /assets/js/nav.js, on n‚Äôa pas besoin de le dupliquer ici -->

  <div class="shell">
    <header class="page-head">
      <h1>AI Lab ‚Äî RAG Glassbox & Diff Explorer</h1>
      <p>
        Le premier outil vous montre <b>comment une r√©ponse d‚ÄôIA s‚Äôappuie vraiment sur votre PDF</b>, √©tape par √©tape.
        Le second compare <b>votre texte ou prompt</b> avec une version am√©lior√©e par l‚ÄôIA, et vous laisse tester les deux.
        C‚Äôest pens√© pour expliquer √† des coll√®gues / apprenants ce qui se passe ‚Äúsous le capot‚Äù.
      </p>
    </header>

    <!-- Barre de config commune -->
    <div class="card">
      <div class="bar">
        <label>Mod√®le
          <select id="model">
            <option value="gpt-5">gpt-5 (par d√©faut via votre API)</option>
            <option value="gpt-4o-mini">gpt-4o-mini</option>
            <option value="gpt-4o">gpt-4o</option>
          </select>
        </label>
        <label class="small">Cl√© OpenAI perso (optionnel)
          <input id="userKey" type="password" placeholder="sk-..." style="min-width:260px">
        </label>
        <span class="small muted">Route API : <code class="mono" id="routeHint"></code></span>
      </div>
      <div class="small muted">
        Par d√©faut, on passe par votre fonction Vercel <code>/api/llm/chat</code> (cl√© c√¥t√© serveur).  
        Si vous saisissez une cl√© perso, l‚Äôappel est fait avec <b>votre</b> cl√© (jamais stock√©e).
      </div>
      <div class="small" style="margin-top:6px;">
        <div><b>1) RAG Glassbox</b> = montrer le pipeline ‚Äúje pose une question sur un PDF ‚Üí l‚ÄôIA r√©pond en se basant sur des passages pr√©cis‚Äù.</div>
        <div><b>2) Diff Explorer</b> = montrer ‚Äúce que change une bonne consigne / un bon prompt‚Äù et si √ßa donne vraiment une meilleure sortie.</div>
      </div>
    </div>

    <!-- Onglets -->
    <div class="tabs">
      <div class="tab active" data-tab="rag">1) RAG Glassbox ‚Äî ‚ÄúExplique-moi ta r√©ponse‚Äù</div>
      <div class="tab" data-tab="diff">2) Code & Prompt Diff Explorer</div>
    </div>

    <!-- Panel RAG -->
    <section class="panel active" id="panel-rag">
      <div class="card grid grid-2">
        <div>
          <h3>Document & Question</h3>
          <p class="small muted">
            RAG = <b>Retrieval Augmented Generation</b> : avant de faire r√©pondre l‚ÄôIA, on va d‚Äôabord <b>r√©cup√©rer les bons morceaux du document</b>.
            Ici, on vous montre ces morceaux.
          </p>
          <div class="bar">
            <input type="file" id="pdfFile" accept="application/pdf">
            <input id="question" style="flex:1" placeholder="Ex. ¬´ Quels sont les objectifs du projet ? ¬ª">
            <button class="primary" id="runRag">Run RAG</button>
          </div>
          <details class="card">
            <summary><b>Ce que vous allez voir</b></summary>
            <ul>
              <li><b>Lecture PDF c√¥t√© navigateur</b> (rien n‚Äôest envoy√© au serveur avant l‚Äôappel LLM)</li>
              <li><b>D√©coupage en chunks</b> (on coupe le PDF en petits blocs exploitables)</li>
              <li><b>Classement</b> : les blocs les plus proches de votre question passent en premier</li>
              <li><b>Appel LLM</b> : la r√©ponse est forc√©e √† citer les blocs ‚Üí vous voyez d‚Äôo√π √ßa vient</li>
            </ul>
          </details>

          <div class="card">
            <h4>Timeline d√©taill√©e (RAG)</h4>
            <p class="small muted">C‚Äôest le ‚Äúfilm‚Äù de ce que fait l‚Äôoutil : si c‚Äôest lent, vous saurez o√π.</p>
            <div id="timeline" class="timeline"></div>
          </div>
        </div>

        <div class="split">
          <div class="box" id="leftPane">
            <h4>Passages s√©lectionn√©s</h4>
            <p class="small muted">
              Ce sont les morceaux du PDF que l‚Äôoutil juge les plus pertinents pour votre question.
              Chaque bloc a un <b>score</b> : plus il est haut, plus c‚Äôest suppos√© √™tre utile.
            </p>
            <div id="passages" class="small"></div>
            <hr>
            <h4>Infos (comment lire)</h4>
            <div id="ragInfo" class="small muted"></div>
            <div class="legend small">
              <b>Chunks retenus</b> : liste des blocs envoy√©s au mod√®le.<br>
              <b>Jauge</b> : estimation tr√®s simple ‚Äúest-ce que la r√©ponse r√©utilise bien le vocabulaire des blocs ?‚Äù.<br>
              <b>Pas scientifique</b> : c‚Äôest une aide visuelle pour expliquer le principe d‚Äô‚Äúancrage‚Äù dans le document.
            </div>
          </div>
          <div class="box" id="rightPane">
            <h4>R√©ponse du mod√®le</h4>
            <p class="small muted">
              Le mod√®le doit r√©pondre <b>uniquement</b> avec les sources envoy√©es.
              Les r√©f√©rences <b>[1]</b>, <b>[2]</b> renvoient aux passages du panneau gauche.
            </p>
            <div id="answer"></div>
            <div class="badges" id="badges"></div>
            <div class="footer-note">Si la r√©ponse est vague ou sans r√©f√©rences, c‚Äôest souvent que la question d√©passe le PDF.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Panel Diff -->
    <section class="panel" id="panel-diff">
      <div class="card">
        <h3>Code & Prompt Diff Explorer (avec test r√©el)</h3>
        <p class="small muted">
          Objectif : montrer que <b>‚Äú√©crire mieux la demande‚Äù</b> peut produire une meilleure sortie.  
          √âtapes : (1) vous collez votre prompt, (2) l‚ÄôIA le r√©√©crit, (3) on teste les 2 sur le m√™me mod√®le et on affiche les sorties c√¥te √† c√¥te.
        </p>

        <!-- 1. Entr√©e -->
        <div class="grid grid-2">
          <div class="box">
            <h4>1. Prompt / texte d‚Äôorigine</h4>
            <textarea id="src" rows="6" placeholder="Ex. ¬´ Fais un dessin de chien en ASCII ¬ª"></textarea>
            <div class="small muted">
              Mettez ici la version ‚Äúcomme l‚Äôutilisateur l‚Äôaurait √©crite‚Äù.
            </div>
          </div>
          <div class="box">
            <h4>2. Ce que vous voulez en mieux</h4>
            <input id="goal" placeholder="Ex. Plus de d√©tails, format structur√©, ton p√©dagogique, exemples‚Ä¶">
            <button class="primary" id="improve">Am√©liorer avec l‚ÄôIA</button>
            <div class="small muted" id="improveStatus"></div>
          </div>
        </div>

        <!-- 2. R√©sultat IA + diff -->
        <div class="grid grid-2" style="margin-top:14px;">
          <div class="box">
            <h4>Prompt am√©lior√© (IA)</h4>
            <textarea id="dst" rows="6" placeholder="La version r√©√©crite appara√Ætra ici‚Ä¶"></textarea>
            <p class="small muted">Vous pouvez retoucher cette version avant de la tester.</p>
          </div>
          <div class="box">
            <h4>Diff texte (ce qui a chang√©)</h4>
            <div id="diff" class="diff small"></div>
            <div class="legend small">
              <span class="ins">vert = ajout√©</span>,
              <span class="del">rouge barr√© = enlev√©</span>.
              √áa sert √† expliquer ‚Äúce que l‚ÄôIA a rajout√©‚Äù.
            </div>
          </div>
        </div>

        <!-- 3. Test r√©el -->
        <div class="card" style="margin-top:14px;">
          <h4>3. Tester les deux sur le m√™me mod√®le</h4>
          <p class="small muted">
            On envoie <b>deux requ√™tes</b> √† votre API : l‚Äôune avec le prompt original, l‚Äôautre avec le prompt am√©lior√©.
            Avec <code>gpt-5</code> √ßa peut prendre 20‚Äì40 s √ó2 ‚Üí regardez la timeline ci-dessous pour savoir o√π √ßa en est.
          </p>
          <div class="bar">
            <input id="ctx" style="flex:1" placeholder="Contexte de test (facultatif), ex. ¬´ Le sujet porte sur le jeu d‚Äôosselets antique ¬ª">
            <button class="primary" id="runTest">Lancer le test sur les 2 prompts</button>
          </div>
          <div class="grid grid-2">
            <div class="box">
              <h4>Sortie avec prompt original</h4>
              <div id="outOrig" class="small"></div>
            </div>
            <div class="box">
              <h4>Sortie avec prompt am√©lior√©</h4>
              <div id="outImproved" class="small"></div>
            </div>
          </div>
          <details style="margin-top:10px;">
            <summary>Voir la timeline du test</summary>
            <div id="timeline-diff" class="timeline"></div>
          </details>
        </div>

        <div class="small muted" style="margin-top:10px;">
          Remarque : cette version appelle un endpoint texte. Pour produire des images, il faudra un endpoint image s√©par√©.
        </div>
      </div>
    </section>
  </div>

<script>
const API_ROUTE = '/api/llm/chat';
document.getElementById('routeHint').textContent = API_ROUTE;

document.querySelectorAll('.tab').forEach(t=>{
  t.onclick = () => {
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    document.getElementById('panel-'+t.dataset.tab).classList.add('active');
  };
});

function estTokens(txt){ return Math.max(1, Math.round((txt||'').length/4)); }
function sanitize(s){ return (s||'').toString().replace(/[<>&]/g, m => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[m])); }

async function callLLM(messages, model, extraHeaders = {}) {
  const headers = {'Content-Type':'application/json', ...extraHeaders};
  const userKey = document.getElementById('userKey').value.trim();
  if (userKey) headers['x-user-api-key'] = userKey;
  const payload = { model, messages };
  const res = await fetch(API_ROUTE, {
    method:'POST',
    headers,
    body: JSON.stringify(payload)
  });
  const raw = await res.text();
  if (!res.ok) throw new Error(`API ${API_ROUTE} ‚Üí ${res.status}: ${raw}`);
  try { return JSON.parse(raw); } catch { return {choices:[{message:{content:raw}}]}; }
}

/* TIMELINE RAG */
function logStepRAG(html, cls=''){
  const el = document.createElement('div');
  el.className = `tstep ${cls}`;
  el.innerHTML = html;
  const root = document.getElementById('timeline');
  root.appendChild(el);
  root.scrollTop = root.scrollHeight;
}
function resetTimelineRAG(){ document.getElementById('timeline').innerHTML=''; }

/* TIMELINE DIFF */
function logStepDiff(html, cls=''){
  const el = document.createElement('div');
  el.className = `tstep ${cls}`;
  el.innerHTML = html;
  const root = document.getElementById('timeline-diff');
  root.appendChild(el);
  root.scrollTop = root.scrollHeight;
}
function resetTimelineDiff(){ document.getElementById('timeline-diff').innerHTML=''; }

/* ===== RAG ===== */
async function pdfToText(file){
  const start = performance.now();
  const buf = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data:buf}).promise;
  logStepRAG(`üìÑ PDF charg√© ‚Äî ${pdf.numPages} page(s)`, 'ok');
  let text = '';
  for (let i=1; i<=pdf.numPages; i++){
    const page = await pdf.getPage(i);
    const c = await page.getTextContent();
    const t = c.items.map(it=>it.str).join(' ');
    text += '\n' + t;
  }
  const dur = Math.round(performance.now() - start);
  logStepRAG(`‚úÇÔ∏è Extraction texte ~${text.length.toLocaleString()} caract√®res en ${dur} ms (moy/page ~${Math.round(text.length/pdf.numPages)} chars)`, 'ok');
  return text.replace(/\s+\n/g,'\n').replace(/\n{2,}/g,'\n\n');
}

function chunkText(text, opts={win:900, overlap:150}){
  const clean = text.replace(/\r/g,'');
  const parts = [];
  let i = 0;
  while (i < clean.length){
    const s = i, e = Math.min(clean.length, i+opts.win);
    let slice = clean.slice(s, e);
    const extra = clean.slice(e, e+120).match(/^[^.!?]*[.!?]/);
    if (extra) slice += extra[0];
    parts.push({id: parts.length+1, start:s, end:s+slice.length, text:slice.trim()});
    i += (opts.win - opts.overlap);
  }
  return parts;
}

const STOP = new Set('a,√†,au,aux,le,la,les,un,une,des,de,du,d,et,ou,mais,que,qui,quoi,pour,par,avec,sans,sur,sous,ces,ce,cette,son,sa,ses,leurs,leur,est,sont,√©t√©,√™tre,ainsi,plus,moins,tr√®s,trop,ne,pas,ni,comme,car,donc,si,lors,afin,chez,entre,vers,contre,selon,chez,quand,ou,o√π'.split(','));
function tokenize(s){
  return s
    .toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^a-z0-9\s]/g,' ')
    .split(/\s+/).filter(w=>w && !STOP.has(w));
}
function tfidfRank(query, chunks){
  const q = tokenize(query);
  const df = new Map();
  for (const ch of chunks){
    const seen = new Set(tokenize(ch.text));
    for (const t of seen) df.set(t, (df.get(t)||0)+1);
  }
  const N = chunks.length;
  const qset = new Set(q);
  for (const ch of chunks){
    const terms = tokenize(ch.text);
    const tf = new Map();
    for (const t of terms) tf.set(t, (tf.get(t)||0)+1);
    let score = 0;
    for (const t of qset){
      const idf = Math.log( (N+1) / ((df.get(t)||0)+1) );
      score += (tf.get(t)||0) * idf;
    }
    ch.score = score;
  }
  return chunks.sort((a,b)=>b.score-a.score);
}
function renderPassages(list, topk){
  const root = document.getElementById('passages');
  root.innerHTML = '';
  list.slice(0, topk).forEach((ch, idx)=>{
    const div = document.createElement('div');
    div.className='card';
    div.innerHTML = `<div class="pill">#${idx+1} (chunk ${ch.id}) ‚Äî score ${ch.score.toFixed(2)}</div>
      <div class="small">${sanitize(ch.text)}</div>`;
    root.appendChild(div);
  });
}
function groundingScore(answer, passages){
  const a = new Set(tokenize(answer));
  const p = new Set(tokenize(passages.map(p=>p.text).join(' ')));
  let inter = 0;
  for (const t of a) if (p.has(t)) inter++;
  const g = a.size ? inter / a.size : 0;
  return Math.max(0, Math.min(1, g));
}

document.getElementById('runRag').onclick = async ()=>{
  try{
    resetTimelineRAG();
    const file = document.getElementById('pdfFile').files[0];
    const q = document.getElementById('question').value.trim();
    if (!file) { alert('Choisissez un PDF'); return; }
    if (!q) { alert('√âcrivez une question'); return; }

    logStepRAG('üß© Lecture du PDF & extraction texte‚Ä¶');
    const text = await pdfToText(file);

    logStepRAG('üß© Chunking (fen√™tre ~900, overlap 150)‚Ä¶');
    const chunks = chunkText(text);
    logStepRAG(`üîç ${chunks.length} chunks g√©n√©r√©s (avg ~${Math.round(text.length/chunks.length)} chars).`,'ok');

    logStepRAG('üßÆ TF-IDF & ranking‚Ä¶');
    const ranked = tfidfRank(q, chunks);
    const top = ranked.slice(0, 6);
    renderPassages(ranked, 6);
    const ctx = top.map((c,i)=>`[${i+1}] ${c.text}`).join('\n\n');

    const sys = `You are a careful RAG assistant. Answer ONLY using the provided SOURCES.
If the answer is not fully supported, explain what is missing and ask for clarification.
Cite sources like [1], [2].`;
    const user = `QUESTION:\n${q}\n\nSOURCES:\n${ctx}`;

    const model = document.getElementById('model').value;
    const inTok = estTokens(sys+user);
    logStepRAG(`üì¶ Contexte construit (‚âà${inTok} tokens estim√©s).`, 'ok');

    const t0 = performance.now();
    logStepRAG(`ü§ñ Appel LLM (${model})‚Ä¶`);
    const resp = await callLLM([
      {role:'system', content: sys},
      {role:'user', content: user}
    ], model);
    const ms = Math.round(performance.now() - t0);
    const content = resp?.choices?.[0]?.message?.content || '(no content)';
    logStepRAG(`‚úÖ R√©ponse re√ßue en ${ms} ms (‚âà${estTokens(content)} tokens)`, 'ok');

    document.getElementById('answer').innerHTML = `<div class="card small">${sanitize(content).replace(/\[(\d+)\]/g,'<b>[$1]</b>')}</div>`;
    const g = groundingScore(content, top);
    const badges = document.getElementById('badges');
    badges.innerHTML = '';
    const b1 = document.createElement('div'); b1.className='badge '+(g>0.45?'ok':(g>0.2?'':'low'));
    b1.textContent = g>0.45? 'Bien ancr√©' : (g>0.2? 'Partiellement ancr√©' : 'Ancrage faible');
    badges.appendChild(b1);

    const info = document.getElementById('ragInfo');
    info.innerHTML = `
      <div>Chunks retenus : ${top.map((c,i)=>`[#${i+1}‚Üí${c.id}]`).join(' ')}</div>
      <div class="score" title="Grounding score"><i style="width:${(g*100).toFixed(0)}%"></i></div>
      <div class="muted">Score = recouvrement lexical simplifi√©, seulement pour montrer le principe.</div>
    `;

  }catch(e){
    logStepRAG('‚õî '+sanitize(e.message||e), 'bad');
    alert(e.message||e);
  }
};

/* ===== DIFF ===== */
document.getElementById('improve').onclick = async ()=>{
  const src = document.getElementById('src').value.trim();
  const goal = document.getElementById('goal').value || 'Rendre le prompt plus clair, plus d√©taill√©, avec un exemple, en fran√ßais.';
  const model = document.getElementById('model').value;
  if (!src){ alert('Mettez un prompt √† gauche.'); return; }
  document.getElementById('improveStatus').textContent = '‚è≥ G√©n√©ration du prompt am√©lior√©‚Ä¶';
  try{
    const sys = `You improve user prompts or short pieces of code.
Return a JSON object with exactly:
{ "code": "...improved prompt...", "why": "short French explanation" }
No markdown fences.`;
    const user = `Objectif: ${goal}
=== PROMPT ORIGINAL ===
${src}`;

    const out = await callLLM([
      {role:'system', content: sys},
      {role:'user', content: user}
    ], model);
    let payload = out?.choices?.[0]?.message?.content || '';
    payload = payload.trim().replace(/^```json\s*/,'').replace(/```$/,'');
    let obj;
    try{ obj = JSON.parse(payload); }
    catch{ throw new Error('R√©ponse non-JSON, r√©essayez.'); }

    const dst = obj.code || '';
    document.getElementById('dst').value = dst;
    document.getElementById('improveStatus').textContent = '‚úÖ Prompt am√©lior√© g√©n√©r√©. Vous pouvez lancer le test sur les 2.';

    if (window.diff_match_patch) {
      const dmp = new diff_match_patch();
      const diffs = dmp.diff_main(src, dst);
      dmp.diff_cleanupSemantic(diffs);
      const html = diffs.map(([op, text])=>{
        text = sanitize(text);
        if (op===1) return `<span class="ins">${text}</span>`;
        if (op===-1) return `<span class="del">${text}</span>`;
        return text;
      }).join('');
      document.getElementById('diff').innerHTML = html;
    } else {
      document.getElementById('diff').innerHTML = '<span class="muted">diff_match_patch non charg√©.</span>';
    }

  }catch(e){
    document.getElementById('improveStatus').textContent = '‚õî '+(e.message||e);
    alert(e.message||e);
  }
};

document.getElementById('runTest').onclick = async ()=>{
  const src = document.getElementById('src').value.trim();
  const dst = document.getElementById('dst').value.trim();
  const model = document.getElementById('model').value;
  const ctx = document.getElementById('ctx').value.trim();
  if (!src){ alert('Pas de prompt original.'); return; }
  if (!dst){ alert('G√©n√©rez d‚Äôabord le prompt am√©lior√©.'); return; }

  const btn = document.getElementById('runTest');
  btn.disabled = true;
  btn.textContent = '‚è≥ Test en cours‚Ä¶';
  document.getElementById('outOrig').textContent = '';
  document.getElementById('outImproved').textContent = '';
  resetTimelineDiff();
  logStepDiff('‚ñ∂Ô∏è Lancement du test : 2 appels vont √™tre faits (original + am√©lior√©).');

  try{
    const start = performance.now();
    logStepDiff('üì® Appel 1/2 avec le prompt original‚Ä¶');
    const r1 = await callLLM([
      {role:'user', content: ctx ? (ctx + '\n\n' + src) : src }
    ], model);
    const ms1 = Math.round(performance.now() - start);
    logStepDiff(`‚úÖ R√©ponse 1/2 re√ßue en ${ms1} ms.`, 'ok');
    const out1 = r1?.choices?.[0]?.message?.content || '(vide)';
    document.getElementById('outOrig').textContent = out1;

    const start2 = performance.now();
    logStepDiff('üì® Appel 2/2 avec le prompt am√©lior√©‚Ä¶');
    const r2 = await callLLM([
      {role:'user', content: ctx ? (ctx + '\n\n' + dst) : dst }
    ], model);
    const ms2 = Math.round(performance.now() - start2);
    logStepDiff(`‚úÖ R√©ponse 2/2 re√ßue en ${ms2} ms.`, 'ok');
    const out2 = r2?.choices?.[0]?.message?.content || '(vide)';
    document.getElementById('outImproved').textContent = out2;

    logStepDiff('üéØ Test termin√©. Comparez visuellement les 2 sorties.','ok');

  }catch(e){
    logStepDiff('‚õî '+sanitize(e.message||e), 'bad');
    alert(e.message||e);
  }finally{
    btn.disabled = false;
    btn.textContent = 'Lancer le test sur les 2 prompts';
  }
};
</script>
</body>
</html>
