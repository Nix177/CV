<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RAG Glassbox + Code & Prompt Diff ‚Äî Lab</title>
  <meta name="theme-color" content="#0a1220" />
  <style>
    :root{
      --bg:#0a1220; --card:#0c1628; --text:#eef3f8; --muted:#a9b6c6; --accent:#4dd0e1; --accent2:#ffa726;
      --good:#4caf50; --warn:#ffb300; --bad:#ef5350; --link:#80deea; --chip:#10223b;
      --ok:#66bb6a; --mid:#fbc02d; --low:#e57373;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,Segoe UI,Roboto,Arial}
    header{padding:16px 20px;border-bottom:1px solid #132946;background:#0b1426;position:sticky;top:0;z-index:2}
    h1{margin:0;font-size:18px;letter-spacing:.2px}
    .tabs{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .tab{padding:8px 12px;border:1px solid #193055;border-radius:8px;cursor:pointer;color:var(--muted)}
    .tab.active{background:linear-gradient(180deg,#13253f,#0e1d35);color:var(--text);border-color:#25497e}
    main{max-width:1100px;margin:20px auto;padding:0 16px 60px}
    section{display:none}
    section.active{display:block}
    .card{background:var(--card);border:1px solid #163055;border-radius:12px;padding:14px;margin:14px 0}
    .row{display:flex;gap:14px;flex-wrap:wrap}
    .col{flex:1 1 360px;min-width:300px}
    input[type="text"], input[type="number"], textarea, select{
      width:100%; background:#0c1a31; color:var(--text); border:1px solid #28466e; border-radius:8px; padding:10px; outline:none;
    }
    textarea{min-height:120px}
    button{
      background:#17345c; border:1px solid #2b538a; color:#e7f5ff; padding:9px 12px; border-radius:8px; cursor:pointer;
    }
    button.primary{background:#1b5e8f;border-color:#2c75ad}
    button:disabled{opacity:.6;cursor:not-allowed}
    .pill{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid #27466f;color:#cfe9ff;padding:4px 8px;border-radius:999px;font-size:12px;margin:2px 6px 2px 0}
    .score{font-weight:600}
    .bar{height:10px;border-radius:999px;background:#11233e;overflow:hidden}
    .bar > span{display:block;height:100%}
    .bar.good > span{background:var(--good)}
    .bar.mid > span{background:var(--warn)}
    .bar.bad > span{background:var(--bad)}
    .badge{display:inline-block;padding:3px 8px;border-radius:999px;font-size:12px;border:1px solid #2a4f80;background:#0d213d;margin-left:8px}
    .badge.good{border-color:#2e7d32;color:#b9f6ca}
    .badge.warn{border-color:#fbc02d;color:#ffecb3}
    .badge.bad{border-color:#d32f2f;color:#ffcdd2}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .hl{background:#2b3f63;outline:2px solid #406299}
    .small{font-size:12px;color:var(--muted)}
    .list{display:grid;gap:10px}
    .chunk{background:#0b1a32;border:1px solid #24436f;border-radius:10px;padding:10px}
    .chunk h4{margin:0 0 4px 0;font-size:14px}
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .diff{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    pre{background:#0b1a32;border:1px solid #24436f;border-radius:10px;padding:10px;overflow:auto;max-height:360px}
    .added{background:#12381e}
    .removed{background:#3a1016}
    .legend{display:flex;gap:8px;align-items:center}
    .legend .box{width:14px;height:14px;border-radius:3px}
    .box.added{background:#1b5e20}
    .box.removed{background:#b71c1c}
    a{color:var(--link)}
    /* Split view */
    .split{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:980px){ .split{grid-template-columns:1fr} }
  </style>

  <!-- libs (no integrity on purpose to avoid SRI block) -->
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";</script>
  <script src="https://cdn.jsdelivr.net/npm/diff@5/dist/diff.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.css">
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-javascript.min.js"></script>
</head>
<body>
  <header>
    <h1>RAG Glassbox + Code & Prompt Diff ‚Äî <span class="small">100% client-side</span></h1>
    <div class="tabs">
      <div class="tab active" data-tab="rag">RAG Glassbox <span class="badge warn">Explainable</span></div>
      <div class="tab" data-tab="diff">Code & Prompt Diff Explorer</div>
    </div>
  </header>

  <main>
    <!-- RAG -->
    <section id="rag" class="active">
      <div class="card">
        <div class="row">
          <div class="col">
            <h3 style="margin:6px 0 10px">1) Charger des documents</h3>
            <input id="fileInput" type="file" multiple accept=".pdf,.txt,.md" />
            <p class="small">Les fichiers restent localement dans le navigateur. Aucune donn√©e envoy√©e c√¥t√© serveur.</p>
            <div class="flex small">
              <label>Chunk size (phrases): <input id="chunkSize" type="number" min="2" max="10" value="5" style="width:80px"></label>
              <label>Overlap: <input id="chunkOverlap" type="number" min="0" max="4" value="1" style="width:80px"></label>
              <label>Top K: <input id="topK" type="number" min="1" max="10" value="5" style="width:80px"></label>
            </div>
          </div>
          <div class="col">
            <h3 style="margin:6px 0 10px">2) Pose ta question</h3>
            <input id="question" type="text" placeholder="Ex: Quels sont les objectifs prioritaires √©voqu√©s ?" />
            <div class="flex" style="margin-top:8px">
              <button class="primary" id="btnBuild">Build index & rank</button>
              <button id="btnAnswer">R√©pondre (local extractif)</button>
            </div>
            <details style="margin-top:10px">
              <summary>‚öôÔ∏è Use LLM (optionnel)</summary>
              <div class="grid2" style="margin-top:8px">
                <div>
                  <label class="small">API Base (ex: https://api.openai.com/v1)</label>
                  <input id="llmBase" type="text" placeholder="https://api.openai.com/v1">
                </div>
                <div>
                  <label class="small">Model (ex: gpt-4o-mini)</label>
                  <input id="llmModel" type="text" placeholder="gpt-4o-mini">
                </div>
                <div>
                  <label class="small">API Key</label>
                  <input id="llmKey" type="text" placeholder="sk-... (attention: expos√©e c√¥t√© client)">
                </div>
                <div>
                  <label class="small">&nbsp;</label>
                  <button id="btnLLM" class="primary">R√©pondre via LLM</button>
                </div>
              </div>
              <p class="small">‚ö†Ô∏è D√©mo uniquement : la cl√© est c√¥t√© client. Pr√©f√©rer un proxy backend pour un usage r√©el.</p>
            </details>
          </div>
        </div>
      </div>

      <div class="split">
        <div class="card">
          <h3 style="margin:6px 0 12px">Passages pertinents (top-K)</h3>
          <div id="chunks" class="list"></div>
        </div>

        <div class="card">
          <div class="flex" style="justify-content:space-between">
            <h3 style="margin:6px 0">R√©ponse & Tra√ßabilit√©</h3>
            <div class="legend small">
              <div class="box added"></div> appui
              <div class="box removed"></div> hors-contexte
            </div>
          </div>
          <div id="answerWrap">
            <div id="answer" class="mono" style="white-space:pre-wrap;background:#0b1a32;border:1px solid #24436f;border-radius:10px;padding:10px;min-height:88px"></div>
          </div>
          <div style="margin-top:10px">
            <div class="flex">
              <div>Grounding score</div>
              <div id="groundBadge" class="badge warn">Low-Grounding</div>
            </div>
            <div class="bar mid" style="margin-top:6px"><span id="groundBar" style="width:0%"></span></div>
            <div class="small" id="groundText" style="margin-top:6px;color:var(--muted)">‚Äî</div>
          </div>

          <div class="card" style="margin-top:12px">
            <h4 style="margin:0 0 6px">Timeline</h4>
            <div id="timeline" class="small"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Diff -->
    <section id="diff">
      <div class="card">
        <div class="row">
          <div class="col">
            <h3 style="margin:6px 0 10px">Code / Prompt (avant)</h3>
            <textarea id="src" placeholder="// Colle ton code ou prompt ici"></textarea>
          </div>
          <div class="col">
            <h3 style="margin:6px 0 10px">Am√©lior√© (apr√®s)</h3>
            <textarea id="dst" placeholder="// R√©sultat am√©lior√© (LLM ou heuristique)"></textarea>
          </div>
        </div>
        <div class="flex" style="margin-top:8px">
          <button id="btnHeu" class="primary">Am√©liorer (heuristique locale)</button>
          <details>
            <summary>‚öôÔ∏è Use LLM (optionnel)</summary>
            <div class="grid2" style="margin-top:8px">
              <div>
                <label class="small">API Base</label><input id="llmBase2" type="text" placeholder="https://api.openai.com/v1">
              </div>
              <div>
                <label class="small">Model</label><input id="llmModel2" type="text" placeholder="gpt-4o-mini">
              </div>
              <div>
                <label class="small">API Key</label><input id="llmKey2" type="text" placeholder="sk-...">
              </div>
              <div style="display:flex;align-items:end"><button id="btnLLM2">Am√©liorer via LLM</button></div>
            </div>
          </details>
          <button id="btnDiff">Voir diff</button>
          <button id="btnExplain">Justification (FR clair)</button>
          <button id="btnExport">Exporter en Markdown</button>
        </div>
      </div>

      <div class="split">
        <div class="card">
          <h3 style="margin:6px 0 8px">Diff side-by-side</h3>
          <div class="diff">
            <pre id="left" class="language-javascript"><code class="language-javascript"></code></pre>
            <pre id="right" class="language-javascript"><code class="language-javascript"></code></pre>
          </div>
          <p class="small">Astuce : choisis ‚Äúlanguage-python‚Äù ou ‚Äúlanguage-javascript‚Äù selon le contenu pour un meilleur highlight (ou laisse par d√©faut).</p>
        </div>

        <div class="card">
          <h3 style="margin:6px 0 8px">M√©triques</h3>
          <div class="row">
            <div class="col">
              <div class="pill">Halstead volume (avant): <span class="score" id="hBefore">‚Äî</span></div>
              <div class="pill">Halstead volume (apr√®s): <span class="score" id="hAfter">‚Äî</span></div>
              <div class="bar" id="hBar" style="margin-top:6px"><span style="width:0%"></span></div>
              <div class="small" id="hText" style="margin-top:6px;color:var(--muted)">‚Äî</div>
            </div>
            <div class="col">
              <div class="pill">Lisibilit√© (avant): <span class="score" id="rBefore">‚Äî</span></div>
              <div class="pill">Lisibilit√© (apr√®s): <span class="score" id="rAfter">‚Äî</span></div>
              <div class="bar" id="rBar" style="margin-top:6px"><span style="width:0%"></span></div>
              <div class="small" id="rText" style="margin-top:6px;color:var(--muted)">‚Äî</div>
            </div>
          </div>
          <div class="card" style="margin-top:10px">
            <h4 style="margin:0 0 6px">Justification</h4>
            <div id="explain" class="mono" style="white-space:pre-wrap"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

<script>
/* ============================
   Tabs
============================ */
document.querySelectorAll('.tab').forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
    t.classList.add('active');
    document.getElementById(t.dataset.tab).classList.add('active');
  };
});

/* ============================
   Utils
============================ */
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
const tokenize = (s)=> (s.toLowerCase().normalize("NFKD").replace(/[^\p{L}\p{N}\s]/gu,' ').split(/\s+/).filter(Boolean));
const sentences = (s)=> s.replace(/\n+/g,' ').split(/(?<=[\.\?\!‚Ä¶])\s+/).map(x=>x.trim()).filter(Boolean);
const uniq = (arr)=>[...new Set(arr)];
function cosine(a, b){
  let dot=0, na=0, nb=0;
  const keys = new Set([...Object.keys(a), ...Object.keys(b)]);
  for(const k of keys){ const va=a[k]||0, vb=b[k]||0; dot+=va*vb; na+=va*va; nb+=vb*vb; }
  return (na&&nb)? dot/Math.sqrt(na*nb) : 0;
}
function tfidfVectors(chunks, query){
  const docs = chunks.map(c=>tokenize(c.text));
  const vocab = new Map(), df = new Map();
  docs.forEach(tokens=>{
    uniq(tokens).forEach(t=>df.set(t,(df.get(t)||0)+1));
    tokens.forEach(t=>vocab.set(t,true));
  });
  const N = docs.length;
  const vecs = docs.map(tokens=>{
    const tf = {}; tokens.forEach(t=>tf[t]=(tf[t]||0)+1);
    const vec = {};
    Object.keys(tf).forEach(t=>{
      const idf = Math.log((N+1)/((df.get(t)||1)+1))+1;
      vec[t] = tf[t]*idf;
    });
    return vec;
  });
  const qtokens = tokenize(query);
  const qtf = {}; qtokens.forEach(t=>qtf[t]=(qtf[t]||0)+1);
  const qvec = {};
  Object.keys(qtf).forEach(t=>{
    const idf = Math.log((N+1)/((df.get(t)||1)+1))+1;
    qvec[t] = qtf[t]*idf;
  });
  return {vecs, qvec};
}
function highlight(text, qwords){
  if(!qwords.length) return text;
  const esc = qwords.map(w=>w.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'));
  const re = new RegExp(`\\b(${esc.join('|')})\\b`, 'gi');
  return text.replace(re, m=>`<mark class="hl">${m}</mark>`);
}

/* ============================
   RAG Glassbox
============================ */
const fileInput = document.getElementById('fileInput');
const chunksDiv = document.getElementById('chunks');
const questionEl = document.getElementById('question');
const topKEl = document.getElementById('topK');
const chunkSizeEl = document.getElementById('chunkSize');
const chunkOverlapEl = document.getElementById('chunkOverlap');
const btnBuild = document.getElementById('btnBuild');
const btnAnswer = document.getElementById('btnAnswer');
const btnLLM = document.getElementById('btnLLM');
const answerEl = document.getElementById('answer');
const timelineEl = document.getElementById('timeline');
const groundBar = document.getElementById('groundBar');
const groundBadge = document.getElementById('groundBadge');
const groundText = document.getElementById('groundText');

let DOCS_TEXT = "";
let BUILT = null; // {chunks, vecs, qvec, ranking}

async function readFileAsText(file){
  const ext = file.name.toLowerCase().split('.').pop();
  if(ext === 'pdf'){
    const arr = new Uint8Array(await file.arrayBuffer());
    const pdf = await pdfjsLib.getDocument({data: arr}).promise;
    let text = "";
    for(let p=1;p<=pdf.numPages;p++){
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();
      const pageText = content.items.map(i=>i.str).join(' ');
      text += pageText + "\n";
    }
    return text;
  } else {
    return await file.text();
  }
}

fileInput.addEventListener('change', async ()=>{
  timelineEl.innerHTML = "üì• Chargement fichiers‚Ä¶";
  DOCS_TEXT = "";
  for (const f of fileInput.files){
    const t = await readFileAsText(f);
    DOCS_TEXT += `\n\n--- FILE: ${f.name} ---\n` + t;
  }
  timelineEl.innerHTML = "‚úÖ Fichiers charg√©s. Pr√™ts pour chunking.";
});

function buildChunks(text, size=5, overlap=1){
  const sents = sentences(text);
  const out = [];
  for(let i=0;i<sents.length;i+=Math.max(1,(size-overlap))){
    const chunk = sents.slice(i, i+size);
    if(chunk.length) out.push({idx: out.length, text: chunk.join(' ')});
  }
  return out;
}

btnBuild.onclick = ()=>{
  const q = questionEl.value.trim();
  if(!DOCS_TEXT){ alert("Charge d'abord des documents."); return; }
  if(!q){ alert("Entre une question."); return; }

  timelineEl.innerHTML = "üß© Chunking‚Ä¶";
  const size = +chunkSizeEl.value||5, ov = +chunkOverlapEl.value||1;
  const chunks = buildChunks(DOCS_TEXT, size, ov);

  timelineEl.innerHTML += "<br>üßÆ TF-IDF & ranking‚Ä¶";
  const {vecs, qvec} = tfidfVectors(chunks, q);
  const scored = chunks.map((c, i)=>({ ...c, score: cosine(vecs[i], qvec) }))
                       .sort((a,b)=>b.score-a.score);

  const K = Math.min(+topKEl.value||5, scored.length);
  const qwords = uniq(tokenize(q)).filter(w=>w.length>2);

  chunksDiv.innerHTML = "";
  for(let i=0;i<K;i++){
    const c = scored[i];
    const item = document.createElement('div');
    item.className = 'chunk';
    item.innerHTML = `
      <h4>#${c.idx} ‚Äî score: <span class="score">${c.score.toFixed(3)}</span></h4>
      <div class="small" style="margin:4px 0 8px">Citation: <span class="pill">${i+1}</span></div>
      <div>${highlight(c.text, qwords)}</div>
    `;
    chunksDiv.appendChild(item);
  }

  BUILT = {chunks, vecs, qvec, ranking: scored.slice(0,K)};
  timelineEl.innerHTML += "<br>‚úÖ Rank pr√™t.";
  answerEl.textContent = "";
  setGrounding(0, "En attente de r√©ponse.");
};

function localAnswer(){
  // extractive baseline: pick top sentences that match query terms
  if(!BUILT){ alert("Clique d'abord ‚ÄòBuild index & rank‚Äô"); return; }
  const q = questionEl.value.trim();
  const qwords = uniq(tokenize(q)).filter(w=>w.length>2);
  const top = BUILT.ranking;
  const candidates = [];
  for(const c of top){
    for(const s of sentences(c.text)){
      const toks = tokenize(s);
      const overlap = toks.filter(t=>qwords.includes(t)).length;
      if(overlap>0){
        candidates.push({s, overlap, source:c.idx});
      }
    }
  }
  candidates.sort((a,b)=>b.overlap-a.overlap);
  const pick = uniq(candidates.map(x=>x.s)).slice(0,6);
  const answer = pick.map((s,i)=>`${s} [${i+1}]`).join(" ");
  return {text: answer || "(Aucun extrait pertinent trouv√©.)", used: candidates.slice(0,6)};
}

function computeGrounding(answer, topChunks){
  const wordsA = uniq(tokenize(answer)).filter(w=>w.length>2);
  const wordsC = uniq(tokenize(topChunks.map(c=>c.text).join(' '))).filter(w=>w.length>2);
  const inBoth = wordsA.filter(w=>wordsC.includes(w)).length;
  const score = wordsA.length? (inBoth/wordsA.length) : 0;
  return score; // 0..1
}

function setGrounding(ratio, txt){
  const pct = Math.round(ratio*100);
  groundBar.style.width = pct + "%";
  groundText.textContent = `${pct}% de recouvrement lexical (heuristique) ‚Äî ${txt||''}`;
  groundBar.parentElement.classList.remove('good','mid','bad');
  groundBadge.classList.remove('good','warn','bad');
  if (ratio>=0.6){ groundBar.parentElement.classList.add('good'); groundBadge.classList.add('good'); groundBadge.textContent='Grounded'; }
  else if (ratio>=0.3){ groundBar.parentElement.classList.add('mid'); groundBadge.classList.add('warn'); groundBadge.textContent='Medium-Grounding'; }
  else { groundBar.parentElement.classList.add('bad'); groundBadge.classList.add('bad'); groundBadge.textContent='Low-Grounding'; }
}

btnAnswer.onclick = ()=>{
  if(!BUILT){ alert("Clique d'abord ‚ÄòBuild index & rank‚Äô"); return; }
  timelineEl.innerHTML += "<br>üß™ R√©ponse extractive locale‚Ä¶";
  const {text} = localAnswer();
  answerEl.textContent = text;
  const g = computeGrounding(text, BUILT.ranking);
  setGrounding(g, "r√©ponse locale (extractive)");
  timelineEl.innerHTML += "<br>‚úÖ Fait.";
};

btnLLM.onclick = async ()=>{
  if(!BUILT){ alert("Clique d'abord ‚ÄòBuild index & rank‚Äô"); return; }
  const base = document.getElementById('llmBase').value.trim();
  const model = document.getElementById('llmModel').value.trim();
  const key = document.getElementById('llmKey').value.trim();
  if(!base || !model || !key){ alert("Renseigne API Base, Model et API Key."); return; }
  const q = questionEl.value.trim();
  const ctx = BUILT.ranking.map((c,i)=>`[${i+1}] ${c.text}`).join("\n\n");
  const prompt = `You are a RAG assistant. Answer the QUESTION strictly grounded in the PASSAGES.
If you don't find evidence, say you cannot answer.
Return short paragraphs with [n] citations.

QUESTION:
${q}

PASSAGES:
${ctx}
  `.trim();
  timelineEl.innerHTML += "<br>ü§ñ Appel LLM‚Ä¶";
  try{
    const res = await fetch(base.replace(/\/$/,'') + "/chat/completions", {
      method:"POST",
      headers:{ "Content-Type":"application/json", "Authorization": `Bearer ${key}` },
      body: JSON.stringify({
        model, messages:[{role:"user", content: prompt}], temperature: 0.2
      })
    });
    const data = await res.json();
    const text = data?.choices?.[0]?.message?.content || "(no response)";
    answerEl.textContent = text;
    const g = computeGrounding(text, BUILT.ranking);
    setGrounding(g, "r√©ponse LLM (cit√©e)");
    timelineEl.innerHTML += "<br>‚úÖ LLM OK.";
  }catch(e){
    console.error(e);
    alert("Erreur LLM (CORS/cl√©/mod√®le). Regarde la console.");
  }
};

/* ============================
   Diff Explorer
============================ */
const srcEl = document.getElementById('src');
const dstEl = document.getElementById('dst');
const leftPre = document.getElementById('left').querySelector('code');
const rightPre = document.getElementById('right').querySelector('code');
const btnHeu = document.getElementById('btnHeu');
const btnLLM2 = document.getElementById('btnLLM2');
const btnDiff = document.getElementById('btnDiff');
const btnExplain = document.getElementById('btnExplain');
const btnExport = document.getElementById('btnExport');

const hBefore = document.getElementById('hBefore');
const hAfter = document.getElementById('hAfter');
const hBar = document.getElementById('hBar').querySelector('span');
const hBarWrap = document.getElementById('hBar');
const hText = document.getElementById('hText');

const rBefore = document.getElementById('rBefore');
const rAfter = document.getElementById('rAfter');
const rBar = document.getElementById('rBar').querySelector('span');
const rBarWrap = document.getElementById('rBar');
const rText = document.getElementById('rText');
const explainDiv = document.getElementById('explain');

function halsteadVolume(code){
  // super simple heuristic
  const ops = ['+','-','*','/','%','=','+=','-=','*=','/=','==','===','!=','!==','<','>','<=','>=','&&','||','!','++','--','=>','.',',',':',';','?','&','|','^','~','<<','>>','>>>','new','return','if','else','for','while','switch','case','break','continue','try','catch','throw','class','function','def','lambda','import','from','as','with','await','async','yield'];
  const tokens = code.match(/[A-Za-z_][A-Za-z0-9_]*|==?=?|!==?|<=?|>=?|[\+\-\*\/%=&\|\^\~\!<>]+|[.,:;?(){}\[\]]/g)||[];
  let N1=0,N2=0; const opSet=new Set(), idSet=new Set();
  tokens.forEach(t=>{
    if(ops.includes(t) || /^(==?=?|!==?|<=?|>=?|[\+\-\*\/%=&\|\^\~\!<>]+|[.,:;?(){}\[\]])$/.test(t)){ N1++; opSet.add(t); }
    else { N2++; idSet.add(t); }
  });
  const n1=opSet.size, n2=idSet.size;
  const vocab = n1+n2, length = N1+N2;
  const volume = length * (Math.log2(Math.max(2,vocab)));
  return {volume, vocab, length, n1,n2,N1,N2};
}
function readability(promptText){
  // approximate: score 0..100 where higher = easier
  const sents = sentences(promptText);
  const words = tokenize(promptText);
  const syll = words.reduce((acc,w)=>acc+Math.max(1,Math.ceil(w.replace(/[^aeiouy]/gi,' ').split(/\s+/).filter(Boolean).length)),0);
  const ASL = sents.length? words.length/sents.length : words.length;
  const ASW = words.length? syll/words.length : 1;
  // Flesch-like (rough)
  let score = 206.835 - 1.015*ASL - 84.6*ASW;
  if(!isFinite(score)) score = 0;
  score = Math.max(0, Math.min(100, score));
  return {score, ASL, ASW, words:words.length, sents:sents.length};
}
function setMetricBars(hVolBefore, hVolAfter, rB, rA){
  hBefore.textContent = hVolBefore.volume.toFixed(1);
  hAfter.textContent = hVolAfter.volume.toFixed(1);
  const delta = hVolBefore.volume - hVolAfter.volume;
  const norm = Math.max(0, Math.min(100, 50 + (delta/ (hVolBefore.volume+1))*50 ));
  hBar.style.width = norm + "%";
  hBarWrap.classList.remove('good','mid','bad');
  hText.textContent = (delta>0? "‚Üì Complexit√© estim√©e r√©duite" : delta<0? "‚Üë Complexit√© estim√©e augment√©e" : "‚âà Inchang√©");
  hBarWrap.classList.add(delta>0?'good':(delta<0?'bad':'mid'));

  rBefore.textContent = rB.score.toFixed(0);
  rAfter.textContent = rA.score.toFixed(0);
  const rd = rA.score - rB.score;
  const rnorm = Math.max(0, Math.min(100, 50 + rd/2 ));
  rBar.style.width = rnorm + "%";
  rBarWrap.classList.remove('good','mid','bad');
  rText.textContent = (rd>0? "‚Üë Plus lisible" : rd<0? "‚Üì Moins lisible" : "‚âà Lisibilit√© comparable");
  rBarWrap.classList.add(rd>0?'good':(rd<0?'bad':'mid'));
}
function renderDiff(left, right){
  const diffs = Diff.diffLines(left, right);
  // left
  let lhtml = "";
  let rhtml = "";
  diffs.forEach(part=>{
    const esc = (s)=>s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    if(part.removed){
      lhtml += `<span class="removed">${esc(part.value)}</span>`;
    }else if(part.added){
      rhtml += `<span class="added">${esc(part.value)}</span>`;
    }else{
      lhtml += esc(part.value);
      rhtml += esc(part.value);
    }
  });
  leftPre.innerHTML = lhtml;
  rightPre.innerHTML = rhtml;
  Prism.highlightElement(leftPre);
  Prism.highlightElement(rightPre);
}
function heuristicImprove(s){
  // Code: trim, normalize quotes, dedupe imports, simple reorder imports
  if(/[{}();]/.test(s) || /import\s+|def\s+|function\s+|class\s+/.test(s)){
    let out = s.split('\n').map(l=>l.replace(/\s+$/,'')).join('\n');
    out = out.replace(/"([^"]*)"/g,"'$1'"); // dumb quote normalize
    const lines = out.split('\n');
    const imports = lines.filter(l=>/^\s*(import|from)\s+/.test(l));
    const rest = lines.filter(l=>!imports.includes(l));
    const uniqImports = [...new Set(imports)].sort((a,b)=>a.localeCompare(b));
    out = [...uniqImports, '', ...rest].join('\n').replace(/\n{3,}/g,'\n\n');
    return out;
  } else {
    // Prompt: bulletize constraints, add role & success conditions
    const raw = s.trim();
    const items = sentences(raw);
    const constraints = items.filter(x=>/must|do|avoid|ensure|clear|include|step|format|return|in French|en fran√ßais|JSON|schema/i.test(x));
    const goal = items.find(x=>/summarize|explain|refactor|improve|analyze|classify|translate|generate/i.test(x)) || items[0] || 'Clarify and improve.';
    let out = `Role: You are a precise assistant optimizing prompts for clarity and determinism.\nGoal: ${goal}\n\nConstraints:\n`;
    constraints.forEach(c=> out += `- ${c}\n`);
    out += `\nOutput:\n- Short, structured result.\n- If code, provide a minimal reproducible snippet.\n- Avoid hallucinations; say "insufficient context" if needed.\n`;
    return out;
  }
}

/* actions */
btnHeu.onclick = ()=>{
  dstEl.value = heuristicImprove(srcEl.value);
};
btnLLM2.onclick = async ()=>{
  const base = document.getElementById('llmBase2').value.trim();
  const model = document.getElementById('llmModel2').value.trim();
  const key = document.getElementById('llmKey2').value.trim();
  if(!base || !model || !key){ alert("Renseigne API Base, Model et API Key."); return; }
  const sys = "You improve code or prompts. Return only the improved content, no explanations.";
  const user = srcEl.value;
  try{
    const res = await fetch(base.replace(/\/$/,'') + "/chat/completions", {
      method:"POST",
      headers:{ "Content-Type":"application/json", "Authorization": `Bearer ${key}` },
      body: JSON.stringify({ model, messages:[{role:"system",content:sys},{role:"user",content:user}], temperature:0.2 })
    });
    const data = await res.json();
    dstEl.value = data?.choices?.[0]?.message?.content || "";
  }catch(e){ console.error(e); alert("Erreur LLM (CORS/cl√©/mod√®le)."); }
};
btnDiff.onclick = ()=>{
  renderDiff(srcEl.value, dstEl.value);
  const hb = halsteadVolume(srcEl.value);
  const ha = halsteadVolume(dstEl.value);
  const rb = readability(srcEl.value);
  const ra = readability(dstEl.value);
  setMetricBars(hb,ha,rb,ra);
};
btnExplain.onclick = ()=>{
  const diffs = Diff.diffWords(srcEl.value, dstEl.value);
  const adds = diffs.filter(d=>d.added).map(d=>d.value).join(' ').trim();
  const dels = diffs.filter(d=>d.removed).map(d=>d.value).join(' ').trim();
  let exp = "";
  if (/[{}();]/.test(srcEl.value)) {
    exp += "‚Ä¢ Code: simplification des imports, normalisation des guillemets, suppression des espaces tra√Ænants.\n";
    exp += "‚Ä¢ Effet attendu: lisibilit√© accrue, diff plus stable, bruit r√©duit dans les PR.\n";
  } else {
    exp += "‚Ä¢ Prompt: r√¥le explicite, objectifs clarifi√©s, contraintes bulletis√©es, crit√®res de sortie.\n";
    exp += "‚Ä¢ Effet attendu: sorties plus d√©terministes, meilleure reproductibilit√©.\n";
  }
  exp += `\n+ Ajouts marquants: ${adds.slice(0,300) || "(minimes)"}\n- Suppressions cl√©s: ${dels.slice(0,300) || "(minimes)"}\n`;
  explainDiv.textContent = exp;
};
btnExport.onclick = ()=>{
  const md =
`# Diff Report

## Before
\`\`\`
${srcEl.value}
\`\`\`

## After
\`\`\`
${dstEl.value}
\`\`\`

## Justification
${(explainDiv.textContent||'')}

## Metrics
- Halstead volume (before): ${hBefore.textContent}
- Halstead volume (after): ${hAfter.textContent}
- Readability (before): ${rBefore.textContent}
- Readability (after): ${rAfter.textContent}
`;
  const blob = new Blob([md], {type:'text/markdown'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'diff-report.md'; a.click();
  URL.revokeObjectURL(url);
};
</script>
</body>
</html>
