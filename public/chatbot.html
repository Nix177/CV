<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chatbot IA — Nicolas Tuor</title>
  <link rel="icon" href="/favicon.ico" />
  <link rel="stylesheet" href="/style.css" />

  <style>
    :root{
      --bg:#0b1f33; --panel:#0b2237; --ink:#e6f1ff; --muted:#cfe2ff;
      --bd:#ffffff22; --chip:#0d2a45; --chip2:#103258; --btn:#0e3b63;
      --accent:#60a5fa;
    }
    body{background:radial-gradient(1200px 600px at 20% -10%,rgba(255,255,255,.06),transparent),var(--bg);color:var(--ink);margin:0}
    a{color:#9ecbff}
    .container{max-width:1100px;margin:0 auto;padding:20px}
    /* Navbar */
    .navbar{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 20px;border-bottom:1px solid var(--bd);background:#071a2c;position:sticky;top:0;z-index:10}
    .nav-left,.nav-right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--bd);background:var(--chip);border-radius:12px;color:var(--ink);text-decoration:none}
    .chip:hover{background:var(--chip2)}
    h1{font-size:2.1rem;margin:18px 0}
    /* Slider liberté */
    .slider-row{display:flex;align-items:center;gap:12px;margin:.3rem 0 1rem}
    .slider-row label{opacity:.9}
    input[type="range"]{appearance:none;width:280px;height:10px;border-radius:999px;background:linear-gradient(90deg,#5bb1ff,var(--bd));outline:none}
    input[type="range"]::-webkit-slider-thumb{appearance:none;width:22px;height:22px;border-radius:50%;background:#fff;border:2px solid #3182ce;box-shadow:0 0 0 2px #0b2237}
    /* Chat panel */
    .board{background:rgba(255,255,255,.03);border:1px solid var(--bd);border-radius:14px;padding:16px 16px 10px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:.2rem 0 .8rem}
    .prompt{opacity:.8}
    #chatLog{max-height:min(66vh,620px);overflow:auto;border:1px solid var(--bd);border-radius:12px;padding:8px;background:#051422}
    .bubble{max-width:85%;padding:12px 14px;border-radius:12px;margin:8px 10px;white-space:pre-wrap;line-height:1.42;border:1px solid var(--bd);background:#0d2945}
    .bubble.user{margin-left:auto;background:#0f3558}
    .input-row{display:flex;gap:10px;margin-top:.6rem}
    textarea{flex:1;min-height:74px;border:1px solid var(--bd);border-radius:12px;background:#0a2036;color:var(--ink);padding:12px;resize:vertical}
    .btn{padding:10px 16px;border-radius:12px;border:1px solid var(--bd);background:var(--btn);color:var(--ink);cursor:pointer;white-space:nowrap}
    .btn:hover{filter:brightness(1.08)}
    .muted{opacity:.8}
  </style>
</head>
<body>
  <!-- NAV -->
  <header class="navbar">
    <div class="nav-left">
      <a class="chip" href="/">Accueil</a>
      <a class="chip" href="/portfolio">Portfolio</a>
      <a class="chip" href="/cv">CV</a>
      <a class="chip" href="/chatbot">Chatbot</a>
      <a class="chip" href="/ai-lab">Idées IA</a>
      <a class="chip" href="/fun-facts">Fun Facts</a>
    </div>
    <div class="nav-right">
      <a class="chip" href="/chatbot">FR</a>
      <a class="chip" href="/chatbot-en">EN</a>
      <a class="chip" href="/chatbot-de">DE</a>
    </div>
  </header>

  <main class="container">
    <h1>Chatbot IA</h1>

    <div class="slider-row">
      <label for="libSlider">Liberté</label>
      <input id="libSlider" type="range" min="0" max="2" step="1" value="2" />
      <span id="libVal">2</span>
    </div>

    <p class="muted">
      Posez vos questions — pédagogie, IA, expérience. Le bot charge <code>/profile.json</code> si présent, sinon il s’appuie sur un extrait intégré de mon CV.<br/>
      Astuce : essayez « Quelles compétences techniques ressortent ? », « Parle-moi d’une expérience marquante. », « Quels sont ses centres d’intérêt ? ».
    </p>

    <section class="board">
      <div id="chatLog"></div>

      <div class="input-row">
        <textarea id="chatInput" placeholder="Écrivez votre message… (Entrée pour envoyer, Shift+Entrée pour une nouvelle ligne)"></textarea>
        <button id="chatSend" class="btn">Envoyer</button>
      </div>

      <p class="muted" style="margin:.6rem 0 0">
        Exemples : • Quelles compétences techniques ressortent ? • Parle-moi d’une expérience marquante. • Quelles langues parle-t-il ?
      </p>
    </section>

    <p class="muted" style="margin-top:12px">© Nicolas Tuor — Chatbot de présentation (front-only).</p>
  </main>

  <script>
  /* ================== CONFIG GLOBALE ================== */
  const FREEDOM_DEFAULT = 2;       // 0 = strict / factuel, 1 = souple, 2 = interprétatif (conclut prudemment)
  const MIN_CONF_FOR_STRICT = 0.35; // confiance mini (0..1) pour répondre en mode 0

  // ---------- Fallback CV (si /profile.json n'est pas présent) ----------
  const CV_FALLBACK = {
    nom: "Nicolas Tuor",
    resume: "Enseignant & ingénieur pédagogique (didactique de l’informatique, IA responsable). Expérience: formation, accompagnement, projets numériques éducatifs, pensée critique. Dév web (HTML/CSS/JS), Python (data/IA), prompt-engineering.",
    langues: [
      { langue: "Français", niveau: "C2 (natif)" },
      { langue: "Allemand", niveau: "B2" },
      { langue: "Anglais",  niveau: "B2–C1" }
    ],
    interets: [
      "Vulgarisation scientifique & pensée critique",
      "Astronomie/Astrophotographie",
      "Aviron (2005–2011)",
      "Théâtre d’improvisation",
      "Technologies & outils IA (créations, automatisations d’équipe IA)",
      "Arts martiaux"
    ],
    competences: [
      "Didactique de l’informatique",
      "Intégration responsable de l’IA en éducation",
      "Conception de formations, accompagnement d’enseignants",
      "Analyse de données (Python)",
      "Développement web (HTML/CSS/JS)",
      "Gestion de projet, vulgarisation"
    ],
    projetsIA: [
      "Ateliers IA responsable (biais/limites)",
      "Protos d’outils éducatifs (quiz/facts)",
      "Automatisations légères (scripts, prompts)"
    ],
    qualites: ["Pragmatique", "Rigoureux", "Curieux", "Apprentissage rapide", "Esprit d’équipe"]
  };

  /* ================== UTILITAIRES ================== */
  const $ = (s, r=document)=>r.querySelector(s);
  const log = (...a)=>console.log("%c[chatbot]","color:#0af",...a);
  const toStr = (x)=> (x==null ? "" : String(x)).trim();

  function norm(s){ return toStr(s).toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,""); }
  function tokenSet(s){ return new Set(norm(s).split(/[^a-z0-9]+/).filter(Boolean)); }
  function jaccard(a,b){ const A=tokenSet(a), B=tokenSet(b); const inter=[...A].filter(x=>B.has(x)).length; const uni=new Set([...A,...B]).size; return uni? inter/uni : 0; }

  function bulletList(arr){ return (arr||[]).map(v=>"• "+v).join("  "); }

  /* ================== PROFIL ================== */
  let PROFILE = null;
  async function loadProfile(){
    try{
      const r = await fetch("/profile.json",{cache:"no-store"});
      if(!r.ok) throw new Error("no profile.json");
      const j = await r.json();
      log("profile.json chargé");
      return j;
    }catch(e){
      log("profile.json indisponible → fallback");
      return CV_FALLBACK;
    }
  }

  /* ================== CONNAISSANCE RULE-BASED ================== */
  function extractIndex(p){
    const parts=[];
    parts.push(p.resume);
    (p.langues||[]).forEach(l=>parts.push(`${l.langue} ${l.niveau}`));
    (p.interets||[]).forEach(v=>parts.push(v));
    (p.competences||[]).forEach(v=>parts.push(v));
    (p.projetsIA||[]).forEach(v=>parts.push(v));
    (p.qualites||[]).forEach(v=>parts.push(v));
    return parts.filter(Boolean).join(" • ");
  }

  function answerFromRules(q, p, freedom){
    const qn = norm(q);

    // Règles spécifiques (ajoute/édite librement pour ajuster)
    const KB_RULES = [
      {
        when: /(langue|parle|idiome)/,
        reply: () => (p.langues||[]).map(l=>`${l.langue} — ${l.niveau}`).join("; ")
          || "Français natif, bon niveau en anglais et allemand."
      },
      {
        when: /(hobbi|interet|loisir)/,
        reply: () => (p.interets && p.interets.length)
          ? `Centres d’intérêt : ${p.interets.join(", ")}.`
          : "Rien de listé précisément ; il est curieux et apprend vite."
      },
      {
        when: /(competenc|techniq|skill)/,
        reply: () => (p.competences && p.competences.length)
          ? `Compétences clés : ${p.competences.join(", ")}.`
          : "Compétences pédagogie / numérique / IA indiquées de manière générale."
      },
      {
        when: /(projet.*ia|ia appliquee|prompt|automati(s|z))/,
        reply: () => (p.projetsIA && p.projetsIA.length)
          ? `Projets IA : ${p.projetsIA.join("; ")}.`
          : "Expériences autour de l’IA responsable, du prototypage front et de l’automatisation légère."
      },
      {
        when: /(astro(photo)?|astronomie)/,
        reply: () => "Astrophotographie : prise d’images du ciel profond / planétaire ; suppose patience, technique (poses longues, calibration) et traitement d’images."
      },
      {
        when: /(atout|distingu|point fort|force|qualit)/,
        reply: () => (p.qualites?.length)
          ? `Forces perçues : ${p.qualites.join(", ")}.`
          : "Approche pragmatique, rigoureuse, goût pour relier pédagogie et usages concrets."
      },
      {
        when: /(equipe|manager|mener).*(recherch|projet|groupe)/,
        reply: () => "Habitué à coordonner de petites initiatives pédagogiques ; en contexte plus large, il s’aligne au cadre et apprend vite."
      }
    ];

    for(const rule of KB_RULES){
      if(rule.when.test(qn)){
        const txt = rule.reply();
        return { text: txt, conf: 0.9 };
      }
    }
    return null;
  }

  function softSynthesis(q, p, freedom){
    // Recherche “floue” dans l’index pour donner une piste quand on est sur 1 ou 2
    const idx = extractIndex(p);
    const conf = jaccard(q, idx); // 0..1
    if (conf < (freedom === 0 ? MIN_CONF_FOR_STRICT : 0.05)) return null;

    if (freedom === 2) {
      return {
        text: "Voici une réponse synthétique basée sur son profil : " +
              "il relie pédagogie, pensée critique et outils numériques/IA. " +
              "Curieux et rapide à se mettre à niveau, il privilégie l’impact concret.",
        conf
      };
    }
    return {
      text: "Éléments pertinents issus du profil : " +
            bulletList([...(p.competences||[]).slice(0,3), ...(p.interets||[]).slice(0,2)]),
      conf
    };
  }

  function finalAnswer(q, p, freedom){
    const hit = answerFromRules(q, p, freedom);
    if (hit) return hit.text;

    const soft = softSynthesis(q, p, freedom);
    if (soft) return soft.text;

    if (freedom > 0){
      return "Je peux préciser ses compétences, langues, expériences, centres d’intérêt, projets IA ou qualités. Donne-moi l’axe exact à couvrir.";
    }
    return "Je réponds avec prudence aux informations explicites du profil. Demande par exemple : « Quelles compétences techniques ressortent ? »";
  }

  /* ================== UI ================== */
  const logEl  = ()=>$("#chatLog");
  const input  = ()=>$("#chatInput");
  const sendBt = ()=>$("#chatSend");
  const slider = ()=>$("#libSlider");
  const libVal = ()=>$("#libVal");

  function addBubble(text, who="bot"){
    const line = document.createElement("div");
    line.className = "bubble " + who;
    line.textContent = String(text || "");
    logEl().appendChild(line);
    logEl().scrollTop = logEl().scrollHeight;
  }

  async function ask(){
    const q = input().value.trim();
    if(!q) return;
    addBubble(q, "user");
    input().value = "";

    const freedom = Number(slider().value||FREEDOM_DEFAULT);
    const a = finalAnswer(q, PROFILE||{}, freedom);
    addBubble(a, "bot");
  }

  /* ================== INIT ================== */
  (async function init(){
    slider().value = FREEDOM_DEFAULT;
    libVal().textContent = FREEDOM_DEFAULT;
    slider().addEventListener("input", ()=>{ libVal().textContent = slider().value; });

    PROFILE = await loadProfile();

    addBubble("Bonjour ! Posez une question sur le candidat.", "bot");
  })();

  sendBt().addEventListener("click", ask);
  input().addEventListener("keydown",(e)=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); ask(); }});
  </script>
</body>
</html>
