<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Chatbot — Nicolas Tuor</title>
  <link rel="stylesheet" href="/style.css"/>
  <!-- Favicon inline pour éviter tout 404 -->
  <link rel="icon" type="image/svg+xml"
    href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 64 64"><rect width="64" height="64" rx="12" fill="%230b2237"/><text x="50%" y="58%" text-anchor="middle" font-family="Arial" font-size="34" fill="%23cfe2ff">NT</text></svg>'/>
  <style>
    :root{
      --bg:#0b1f33;--panel:#0b2237;--ink:#e6f1ff;--muted:#cfe2ff;
      --glass:rgba(255,255,255,.08);--bd:#ffffff22;--brand:#93c5fd;
    }
    body{background:var(--bg);color:var(--ink);margin:0}
    .navbar{display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:14px 20px;border-bottom:1px solid var(--bd);background:#081c30}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--bd);
      background:#0d2a45;border-radius:12px;color:var(--ink);text-decoration:none}
    .chip:hover{background:#12345f}
    .container{max-width:1100px;margin:0 auto;padding:20px}
    h1{margin:8px 0 14px 0}
    .help{opacity:.8;margin:4px 0 16px}

    /* Controls */
    .controls{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:12px}
    .range-wrap{display:flex;align-items:center;gap:10px;border:1px solid var(--bd);border-radius:12px;padding:10px 12px;background:#0d2a45}
    .range-wrap label{opacity:.9}
    .range-wrap output{min-width:2ch;text-align:center;background:#12345f;border:1px solid var(--bd);border-radius:8px;padding:4px 8px}
    input[type=range]{appearance:none;width:220px;height:8px;border-radius:10px;background:#2a3b55;outline:none}
    input[type=range]::-webkit-slider-thumb{appearance:none;width:18px;height:18px;border-radius:50%;background:#b3e5ff;border:2px solid #0b192a;cursor:pointer}
    input[type=range]::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:#b3e5ff;border:2px solid #0b192a;cursor:pointer}
    .ticks{display:flex;justify-content:space-between;width:220px;margin-top:2px;font-size:.8rem;opacity:.6}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--bd);border-radius:12px;padding:8px 12px;background:#0d2a45}

    /* Chat */
    .box{border:1px solid var(--bd);border-radius:14px;padding:12px;background:#081a2d}
    .log{height:min(60vh,560px);overflow:auto;display:flex;flex-direction:column;gap:10px;padding:10px;background:#071629;border-radius:10px;border:1px solid var(--bd)}
    .row{display:flex}
    .bubble{max-width:86%;padding:10px 12px;border-radius:12px;line-height:1.4}
    .me{margin-left:auto;background:linear-gradient(180deg,#0f2b46,#0b1f33);border:1px solid var(--bd)}
    .bot{margin-right:auto;background:rgba(255,255,255,.06);border:1px solid var(--bd)}
    .inputs{display:flex;gap:8px;margin-top:10px}
    textarea{flex:1;min-height:64px;max-height:180px;padding:10px;border-radius:10px;border:1px solid var(--bd);background:#0b2237;color:var(--ink)}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--bd);background:#0e3b63;color:var(--ink);cursor:pointer}
    .btn:hover{background:#0f4a7f}
    @media (max-width:720px){
      .navbar{gap:6px;padding:10px}
      .chip{padding:6px 10px}
      .controls{gap:8px}
      input[type=range]{width:180px}
      .ticks{width:180px}
      .bubble{max-width:92%}
    }
  </style>
</head>
<body>
  <!-- NAV -->
  <header class="navbar">
    <div class="nav-left">
      <a class="chip" href="/">Accueil</a>
      <a class="chip" href="/portfolio">Portfolio</a>
      <a class="chip" href="/cv">CV</a>
      <a class="chip" href="/chatbot">Chatbot</a>
      <a class="chip" href="/ai-lab">Idées IA</a>
      <a class="chip" href="/fun-facts">Fun Facts</a>
    </div>
    <div class="nav-right">
      <a class="chip" href="/chatbot">FR</a>
      <a class="chip" href="/chatbot-en">EN</a>
      <a class="chip" href="/chatbot-de">DE</a>
    </div>
  </header>

  <main class="container">
    <h1>Chatbot IA</h1>
    <div class="help">Réglez la <strong>liberté</strong> pour ajuster l’interprétation : <strong>0</strong> = factuel (uniquement CV/profil) • <strong>1</strong> = prudent • <strong>2</strong> = interprétatif (extrapolations signalées).</div>

    <div class="controls">
      <div class="range-wrap">
        <label for="lib">Liberté</label>
        <input id="lib" type="range" min="0" max="2" step="1" value="1" />
        <output id="libVal">1</output>
        <div class="ticks"><span>0</span><span>1</span><span>2</span></div>
      </div>
      <label class="badge"><input id="concise" type="checkbox" checked style="margin-right:8px"/> Réponses concises</label>
    </div>

    <div class="box">
      <div id="log" class="log" aria-live="polite"></div>
      <div class="inputs">
        <textarea id="msg" placeholder="Écrivez votre message… (Entrée pour envoyer, Shift+Entrée pour nouvelle ligne)"></textarea>
        <button id="send" class="btn">Envoyer</button>
      </div>
    </div>
  </main>

  <script>
  (function(){
    "use strict";

    const $ = (s,r=document)=>r.querySelector(s);
    const logEl = $("#log"), input=$("#msg"), btn=$("#send");
    const lib = $("#lib"), libVal=$("#libVal"), conc=$("#concise");
    const info = (...a)=>console.log("%c[chatbot]","color:#0af",...a);
    const warn = (...a)=>console.warn("%c[chatbot]","color:#fa0",...a);

    function addBubble(text, who="bot"){
      const row = document.createElement("div");
      row.className = "row";
      const b = document.createElement("div");
      b.className = "bubble " + (who==="me"?"me":"bot");
      b.textContent = String(text || "");
      row.appendChild(b);
      logEl.appendChild(row);
      logEl.scrollTop = logEl.scrollHeight;
    }

    const STATE = { freedom:1, concise:true, profile:null, cvtext:"" };

    lib.addEventListener("input", ()=>{ libVal.textContent = lib.value; STATE.freedom = Number(lib.value); });
    conc.addEventListener("change", ()=>STATE.concise = conc.checked);

    async function fetchText(url){
      try{ const r = await fetch(url,{cache:"no-store"}); if(!r.ok) throw 0; return await r.text(); }
      catch{ return null; }
    }
    async function fetchJSON(url){
      try{ const r = await fetch(url,{cache:"no-store"}); if(!r.ok) throw 0; return await r.json(); }
      catch(e){ warn("fetch error", url, e); return null; }
    }

    async function loadKnowledge(){
      STATE.profile = await fetchJSON("/profile.json");
      if(!STATE.profile) info("profile.json absent (fallback ok)"); else info("profile.json OK");
      STATE.cvtext = (await fetchText("/cv-text.txt")) || "";
      if(STATE.cvtext) info("cv-text.txt OK");
    }

    // -------- extraction tolérante des formats LLM --------
    function extractTextFromLLMPayload(js){
      if(typeof js === "string") return js;

      // { answer: "..." }
      if(js && typeof js.answer === "string") return js.answer;

      // { content: "..." }  ou {message:{content:"..."}}
      if(js && typeof js.content === "string") return js.content;
      if(js && js.message && typeof js.message.content === "string") return js.message.content;

      // { output_text: "..." } (certains frameworks)
      if(js && typeof js.output_text === "string") return js.output_text;

      // OpenAI-like { choices:[{message:{content:"..."}}] }
      if(js && Array.isArray(js.choices) && js.choices[0]){
        const c = js.choices[0];
        if(c.message && typeof c.message.content === "string") return c.message.content;
        if(typeof c.text === "string") return c.text;
      }

      // { messages:[{role, content}, ...] } => prendre dernier assistant
      if(js && Array.isArray(js.messages)){
        for(let i=js.messages.length-1;i>=0;i--){
          const m=js.messages[i];
          if(m && (m.role==="assistant" || !m.role) && typeof m.content==="string") return m.content;
        }
      }

      // { result: { ... } } récurrent
      if(js && js.result) return extractTextFromLLMPayload(js.result);

      // { data: { answer / content / output_text } }
      if(js && js.data) return extractTextFromLLMPayload(js.data);

      // rien d'exploitable
      try{ return JSON.stringify(js); }catch{ return ""; }
    }

    async function tryLLM(question, knowledge, freedom){
      try{
        const r = await fetch("/api/chat", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({
            system:
`Tu es un assistant de recrutement.
- Base-toi d'abord sur le CV/profil remis ci-dessous.
- Liberté ${freedom} : 0 factuel, 1 prudent, 2 interprétatif (signale quand c'est déduit).
- Réponds en français, clairement, sans prétendre connaître plus que les données.`,
            profile: knowledge,
            freedom,
            question
          })
        });
        if(!r.ok) return null;
        const js = await r.json();
        const text = extractTextFromLLMPayload(js);
        return text && text.trim() ? text : null;
      }catch{ return null; }
    }

    function textList(arr, n=8){
      return (arr||[]).map(x=>typeof x==="string"?x:(x.name||x.langue||x.title||x.detail||x.level||JSON.stringify(x))).slice(0,n).join(", ");
    }

    function normalizeAnswer(ans){
      if(ans == null) return "";
      if(typeof ans === "string") return ans;
      if(Array.isArray(ans)) return ans.map(x=>normalizeAnswer(x)).join("\n");
      if(typeof ans === "object"){
        if(typeof ans.answer === "string") return ans.answer;
        if(typeof ans.content === "string") return ans.content;
        try{ return JSON.stringify(ans); }catch{ return String(ans); }
      }
      return String(ans);
    }

    function firstSentences(t, n){
      const re = /[^.!?]+[.!?]?/g;
      const out = [];
      const txt = String(t||"").replace(/\s+/g," ").trim();
      let m; while((m=re.exec(txt)) && out.length<n){ out.push(m[0].trim()); }
      return out.join(" ");
    }

    function makeConcise(s){
      s = normalizeAnswer(s);
      if(!s) return "";
      if (/^\s*[-–•]/m.test(s)){
        return s.split(/\n+/).slice(0,6).join("\n");
      }
      return firstSentences(s, 3);
    }

    function ruleBasedAnswer(q, P){
      const msg = q.toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,"");
      const langs = (P.languages||[]).map(l=>`${l.name} — ${l.level}`).join("; ");
      const inter = textList(P.interests, 10);
      const skills = P.skills||{};
      const ped = textList(skills.pedagogy, 8);
      const tech = textList(skills.tech, 8);
      const proj = textList(skills.project, 6);

      if(/langue|parle|idiome/.test(msg)) return langs || "Le CV mentionne surtout le français, avec un bon niveau d’anglais et d’allemand.";
      if(/hobbi|loisir|interet|passion/.test(msg)) return inter ? `Centres d’intérêt : ${inter}.` : "Centres d’intérêt non détaillés ici.";
      if(/competenc|skill/.test(msg)) return `Compétences pédagogiques : ${ped}. Compétences techniques : ${tech}. Gestion/coordination : ${proj}.`;
      if(/equipe|diriger|leader|manager|chercheur/.test(msg)) return "Le CV n’indique pas un poste de direction explicite ; toutefois la coordination, la formation et la documentation soutiennent un rôle d’équipe solide. (DÉDUIT)";
      if(/ia|numeriqu|edtech|automatis/.test(msg)) return "Intérêt pour l’éducation numérique et l’IA responsable, ateliers modulables et intégration d’outils simples (automatisations légères).";
      return "Je peux préciser langues, compétences, expériences, centres d’intérêt ou projets IA. Indiquez l’axe souhaité.";
    }

    async function ask(){
      const q = input.value.trim();
      if(!q) return;
      input.value = "";
      addBubble(q, "me");

      const P = STATE.profile || {};
      const knowledge = {
        summary: P.summary || "",
        education: P.education || [],
        languages: P.languages || [],
        values: P.values || [],
        skills: P.skills || {},
        experience: P.experience || [],
        interests: P.interests || [],
        talking_points: P.talking_points || [],
        notes: P.notes || [],
        chatgpt_additions: P.chatgpt_additions || {}
      };
      if(STATE.cvtext) knowledge.cvtext = STATE.cvtext;

      let ans = await tryLLM(q, knowledge, STATE.freedom);
      if(!ans) ans = ruleBasedAnswer(q, P);

      ans = normalizeAnswer(ans);
      if(STATE.freedom === 2 && /deduit|déduit/i.test(ans) === false){
        if(/peut|pourrait|laisser penser|suggere|suggère/i.test(ans)) ans += " (DÉDUIT)";
      }
      if(STATE.concise) ans = makeConcise(ans);

      addBubble(ans, "bot");
    }

    (async function init(){
      await loadKnowledge();
      lib.dispatchEvent(new Event("input"));
      addBubble("Bonjour ! Posez une question sur le candidat.", "bot");
      input.addEventListener("keydown", (e)=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); ask(); }});
      btn.addEventListener("click", ask);
    })();
  })();
  </script>
</body>
</html>
