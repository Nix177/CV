<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Chatbot IA â€” Nicolas Tuor</title>

  <!-- Favicon inline pour Ã©viter le 404 -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><text y="50%" x="50%" dominant-baseline="middle" text-anchor="middle" font-size="52">ðŸ¤–</text></svg>'>

  <link rel="stylesheet" href="/style.css">

  <style>
    .chat { max-width: 920px; margin: 0 auto; padding: 16px; }
    .chat-box { background: var(--panel); border:1px solid color-mix(in oklab,var(--ink),transparent 85%); border-radius:16px; padding:16px; box-shadow:var(--shadow); min-height:260px; }
    .msg { background: var(--bg-soft); border:1px solid color-mix(in oklab,var(--ink),transparent 85%); padding:10px 12px; border-radius:12px; margin:10px 0; white-space:pre-wrap }
    .me { border-color: color-mix(in oklab, var(--brand), transparent 70%); }
    .row { display:flex; gap:10px; margin-top:10px; }
    .row input { flex:1; padding:12px; border-radius:10px; border:1px solid color-mix(in oklab,var(--ink),transparent 80%); background: var(--bg-soft); color: var(--ink); }
    .muted { opacity:.85 }
  </style>

  <!-- PDF.js pour lire /CV_Nicolas_Tuor.pdf cÃ´tÃ© navigateur -->
  <script src="https://unpkg.com/pdfjs-dist@4.8.69/build/pdf.min.js"></script>

  <!-- Injection CV cÃ´tÃ© client (auto si la question concerne le CV, ou si l'utilisateur tape /cv ...) -->
  <!-- Injection CV cÃ´tÃ© client (extrait ciblÃ© + consigne forte) -->
<script>
(function () {
  "use strict";

  // Limites de texte pour Ã©viter de surcharger la requÃªte
  const PAGE_LIMIT   = 14000;  // combien de caractÃ¨res on lit du PDF
  const INJECT_LIMIT = 4500;   // combien on injecte max

  const LABEL = {
    fr: "Extrait du CV (Ã  considÃ©rer comme partie intÃ©grante du profil). RÃ©pondre uniquement Ã  partir de cet extrait :",
    en: "CV extract (treat as part of the profile). Answer using this extract only:",
    de: "CV-Auszug (als Profilbestandteil behandeln). Antworte ausschlieÃŸlich anhand dieses Auszugs:"
  };

  // â€”â€”â€”â€”â€” Utilitaires
  function norm(s){ return (s||"").replace(/\s+/g," ").trim(); }
  function i(label,lang){ return LABEL[lang] || LABEL.fr; }

  // DÃ©tecte une question orientÃ©e CV
  function looksLikeCvQuestion(q) {
    const s = (q||"").toLowerCase();
    if (s.startsWith("/cv ")) return true;                    // forcer
    return /\b(cv|curriculum|rÃ©sumÃ©|resume|lebenslauf|parcours|expÃ©riences?|experience|skills?|compÃ©tences|dipl[oÃ´]me|formation|linkedin|nicolas|tuor|hobbies?|loisirs|intÃ©rÃªts?)\b/.test(s);
  }

  // Lecture PDF -> texte brut (mÃªme origine : /CV_Nicolas_Tuor.pdf)
  async function readCvText() {
    if (!window.pdfjsLib) return "";
    try {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://unpkg.com/pdfjs-dist@4.8.69/build/pdf.worker.min.js";
      const doc = await pdfjsLib.getDocument("/CV_Nicolas_Tuor.pdf").promise;
      let out = "";
      for (let p=1; p<=doc.numPages; p++){
        const page = await doc.getPage(p);
        const c = await page.getTextContent();
        out += c.items.map(i=>i.str).join(" ") + "\n";
        if (out.length > PAGE_LIMIT) break;
      }
      return norm(out);
    } catch(e) {
      console.warn("Lecture CV Ã©chouÃ©e :", e);
      return "";
    }
  }

  // Extrait **ciblÃ©** dâ€™une section (Centres dâ€™intÃ©rÃªt / Hobbies / Loisirs / CompÃ©tences)
  function extractSection(text, pattern){
    // coupe de pattern -> jusquâ€™au prochain titre en MAJ (grossier mais efficace sur PDF text)
    const re = new RegExp(
      "(" + pattern + ")[^\\n]*\\n?([\\s\\S]*?)(\\n[A-ZÃ‰ÃˆÃ€Ã‚ÃŠÃŽÃ”Ã›Ã„Ã–Ãœ0-9 ,.'-]{6,}\\n|$)",
      "i"
    );
    const m = text.match(re);
    if (!m) return "";
    return norm((m[2]||"").slice(0, 1800));
  }

  function buildFocusedExtract(full){
    // Variantes courantes (apostrophes droites/typographiques)
    const interets = extractSection(
      full,
      "CENTRES? D[â€™']?INT[Ã‰E]R[ÃŠE]T|INT[Ã‰E]R[ÃŠE]TS|HOBBIES?|LOISIRS?"
    );
    const compet   = extractSection(full, "COMP[Ã‰E]TENCES?");
    const exp      = extractSection(full, "EXP[Ã‰E]RIENCES? (DIVERSES?|PROFESSIONNELLES?)");

    // PrioritÃ© aux intÃ©rÃªts/hobbies ; si vide, on ajoute compÃ©tences/expÃ©riences pour donner du contexte.
    let parts = [];
    if (interets) parts.push("â€” Centres dâ€™intÃ©rÃªt / Hobbies â€”\n" + interets);
    if (compet)   parts.push("â€” CompÃ©tences â€”\n" + compet.slice(0, 1200));
    if (exp)      parts.push("â€” ExpÃ©riences (extrait) â€”\n" + exp.slice(0, 1000));

    const joined = parts.join("\n\n").slice(0, INJECT_LIMIT);
    return joined || full.slice(0, INJECT_LIMIT);
  }

  let CV_CACHE = "";  // on lit une fois

  // API globale : on rÃ©Ã©crit la question pour forcer lâ€™IA Ã  utiliser lâ€™extrait CV
  window.augmentWithCv = async function(question, lang="fr") {
    if (!looksLikeCvQuestion(question)) return question;
    if (!CV_CACHE) CV_CACHE = await readCvText();
    if (!CV_CACHE) return question; // pas de CV dispo

    const focused = buildFocusedExtract(CV_CACHE);
    const header  = i("header", lang);

    // Consigne forte + extrait + question nettoyÃ©e (sans /cv)
    const cleanQ = question.replace(/^\/cv\s*/i,"").trim();
    return `${header}\n${focused}\n---\nQuestion (prioritÃ© Ã  lâ€™extrait ci-dessus) : ${cleanQ}`;
  };
})();
</script>

</head>
<body>

<header class="site-header">
  <nav class="wrap row" aria-label="Navigation principale" style="padding:10px 16px">
    <a href="/" class="btn ghost">Accueil</a>
    <a href="/portfolio.html" class="btn ghost">Portfolio</a>
    <a href="/cv.html" class="btn ghost">CV</a>
    <a href="/chatbot.html" class="btn" aria-current="page">Chatbot</a>
    <a href="/ai-lab.html" class="btn ghost">IdÃ©es IA</a>
    <a href="/fun-facts.html" class="btn ghost">Fun Facts</a>
    <span style="flex:1"></span>
    <a href="/chatbot.html" class="btn">FR</a>
    <a href="/chatbot-en.html" class="btn ghost">EN</a>
    <a href="/chatbot-de.html" class="btn ghost">DE</a>
  </nav>
</header>

<main class="section container chat">
  <h1 class="title">ðŸ¤– Chatbot IA</h1>
  <p class="lead">Posez vos questions â€” pÃ©dagogie, IA, expÃ©rience. Le bot peut aussi se rÃ©fÃ©rer Ã  mon CV si vous en parlez. <span class="muted">(Astuce : commencez par <code>/cv</code> pour forcer.)</span></p>

  <div id="chat" class="chat-box" aria-live="polite"></div>

  <div class="row">
    <input id="q" type="text"
           placeholder="Exemple : Â« /cv Quelles compÃ©tences techniques ressortent dans le CV ? Â»" />
    <button id="send" class="btn primary">Envoyer</button>
  </div>
</main>

<script>
  const chat = document.getElementById('chat');
  function add(text, me=false){
    const p = document.createElement('div');
    p.className = 'msg' + (me ? ' me' : '');
    p.textContent = text;
    chat.appendChild(p);
    chat.scrollTop = chat.scrollHeight;
  }

  // message dâ€™accueil
  add("Bonjour ! Posez une question sur le candidat.\n\nExemples :\nâ€¢ /cv Quelles compÃ©tences techniques ressortent ?\nâ€¢ /cv Parle-moi de ses expÃ©riences en enseignement.\nâ€¢ A-t-il dÃ©jÃ  fait des projets dâ€™IA appliquÃ©e ?");

  async function ask(){
    const q = document.getElementById('q');
    const raw = (q.value || "").trim();
    if (!raw) return;
    add(raw, true);
    q.value = "";
    add("â€¦");

    try {
      // Injection CV cÃ´tÃ© client (si pertinent)
      const lang = 'fr';
      const question = window.augmentWithCv ? await window.augmentWithCv(raw, lang) : raw;

      const r = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        // Lâ€™API ne change pas. On envoie juste la question possiblement augmentÃ©e.
        body: JSON.stringify({
          question,
          lang,
          // + petit hint facultatif (silencieux si ignorÃ© par le backend)
          cv_url: '/CV_Nicolas_Tuor.pdf'
        })
      });
      const j = await r.json().catch(()=>({}));
      chat.lastChild.textContent = j && j.answer ? j.answer : "Dâ€™accord. Pouvez-vous prÃ©ciser ?";
    } catch (e) {
      chat.lastChild.textContent = "Oups â€” impossible de rÃ©pondre pour lâ€™instant.";
      console.error(e);
    }
  }

  document.getElementById('send').addEventListener('click', ask);
  document.getElementById('q').addEventListener('keydown', e => { if (e.key === 'Enter') ask(); });
</script>
</body>
</html>
