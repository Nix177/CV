<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Chatbot IA — Nicolas Tuor</title>

  <!-- Favicon inline -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><text y="50%" x="50%" dominant-baseline="middle" text-anchor="middle" font-size="52">🤖</text></svg>'>
  <link rel="stylesheet" href="/style.css">

  <style>
    .chat { max-width: 920px; margin: 0 auto; padding: 16px; }
    .chat-box { background: var(--panel); border:1px solid color-mix(in oklab,var(--ink),transparent 85%); border-radius:16px; padding:16px; box-shadow:var(--shadow); min-height:260px; }
    .msg { background: var(--bg-soft); border:1px solid color-mix(in oklab,var(--ink),transparent 85%); padding:10px 12px; border-radius:12px; margin:10px 0; white-space:pre-wrap }
    .me  { border-color: color-mix(in oklab, var(--brand), transparent 70%) }
    .row { display:flex; gap:10px; margin-top:10px }
    .row input { flex:1; padding:12px; border-radius:10px; border:1px solid color-mix(in oklab,var(--ink),transparent 80%); background: var(--bg-soft); color: var(--ink) }
    .muted { opacity:.85 }
    .tiny  { font-size:.85rem; opacity:.85 }
    .status-dot{ display:inline-block; width:8px; height:8px; border-radius:999px; margin-right:6px; translate:0 -1px }
    .ok { background:#16a34a }
  </style>

  <!-- =================== CONTEXTE HARDCODÉ (CV + PROFIL) =================== -->
  <script>
  // ——— CV synthétique (extrait) ———
  const CV_HARDCODED = {
    identite: {
      nom: "Nicolas Tuor",
      localisation: "Fribourg (CH)"
    },
    diplomes: [
      { titre: "Master en didactique disciplinaire (orientation informatique)", etab: "HEP Lausanne", periodes: "2020–2024",
        focus: ["Python", "HTML/CSS", "C++", "enseignement explicite du débogage (travail de master)"] },
      { titre: "Bachelor enseignement préscolaire & primaire", etab: "HEP Fribourg", periodes: "2015–2019",
        focus: ["didactique", "philosophie pour enfants (travail de bachelor)"] }
    ],
    competences: [
      "Méthodologie de recherche et analyse de données",
      "Pédagogie, didactique et formation",
      "Maîtrise des outils numériques",
      "Communication scientifique et vulgarisation",
      "Travail d’équipe interdisciplinaire",
      "Adaptabilité, initiative, résolution de problèmes"
    ],
    tech: ["Python","HTML/CSS/JS","C++","Moodle","Nextcloud","Outils IA (création d’images/vidéos, Copilot, Unity, n8n)"],
    experience: [
      { periode:"2019–…", role:"Enseignant primaire (remplacements)", contexte:"plusieurs degrés / FR" },
      { periode:"2020–2021", role:"Enseignant titulaire 5H", contexte:"École de Corminboeuf" },
      { periode:"2022–2023", role:"Stage de master (recherche/formation)", contexte:"HEP Fribourg (CRE/ATE)" },
      { periode:"2024", role:"Formateur (journée)", contexte:"HEP Fribourg — éducation numérique & IA responsable" },
      { periode:"2017–2023", role:"Divers (service civil, soutien scolaire, archiviste, réception, sécurité)", contexte:"FR/NE" }
    ],
    langues: [
      { langue:"Français", niveau:"langue maternelle" },
      { langue:"Anglais", niveau:"C2" },
      { langue:"Allemand", niveau:"B2/C1" }
    ],
    interets: [
      "Vulgarisation scientifique, pensée critique",
      "Astronomie / Astrophotographie",
      "Aviron (compétition 2005–2011)",
      "Théâtre d’improvisation",
      "Apprentissage en continu",
      "Technologies & IA (création, jeux vidéo, automatisation n8n)",
      "Arts martiaux"
    ]
  };

  // ——— PROFIL / TONALITÉ (nuances) ———
  // Tu peux enrichir librement ce bloc avec d’autres infos de “profile.json”.
  const PROFILE_GUIDE = {
    resume: "Enseignant primaire suisse, orienté didactique de l’informatique et usages responsables de l’IA.",
    valeurs: ["bienveillance pragmatique","communication claire","suivi rigoureux","curiosité","apprentissage rapide"],
    regles: [
      "Toujours rester factuel et sourcer dans le CV quand c’est pertinent.",
      "Ne pas inventer de diplômes ou responsabilités non listés.",
      "S’il manque une info, le dire simplement.",
      "Mentionner que Nicolas apprend vite et se met à niveau rapidement quand la question touche aux langues, technologies ou nouvelles exigences."
    ]
  };

  // ——— Sélection contextuelle : on compose un extrait court pertinent pour la question ———
  function pickContextFor(question){
    const q = (question||"").toLowerCase();
    const ctx = [];

    // Bloc identité + pitch
    ctx.push(`Profil: ${CV_HARDCODED.identite.nom}, ${CV_HARDCODÉD?.identite?.localisation || CV_HARDCODED.identite.localisation}. ${PROFILE_GUIDE.resume}`);

    // Filtres grossiers par mots-clés
    const wantsLang   = /langue|language|spra|english|allemand|anglais|fran|niveau/.test(q);
    const wantsHobby  = /hobb|loisir|int[ée]r[ée]t|passion|centre/.test(q);
    const wantsTech   = /tech|python|html|css|c\+\+|outil|num[ée]rique|ia|ai|unity|copilot|n8n|moodle|nextcloud/.test(q);
    const wantsExp    = /exp[ée]rience|poste|mission|remplacement|enseign|stage|projet/.test(q);
    const wantsComp   = /comp[ée]tence|skill/.test(q);
    const wantsForm   = /dipl[oô]me|formation|master|bachelor|[ée]tude/.test(q);

    if (wantsLang){
      const langs = CV_HARDCODED.langues.map(l=>`${l.langue} (${l.niveau})`).join(", ");
      ctx.push(`Langues: ${langs}.`);
      ctx.push("Nuance: il aime apprendre et se met à niveau rapidement si nécessaire.");
    }
    if (wantsHobby){
      ctx.push("Centres d’intérêt: " + CV_HARDCODED.interets.join("; ") + ".");
    }
    if (wantsTech || wantsComp){
      ctx.push("Compétences clés: " + CV_HARDCODED.competences.join("; ") + ".");
      ctx.push("Technologies/outils: " + CV_HARDCODED.tech.join(", ") + ".");
    }
    if (wantsExp){
      ctx.push("Expérience (sélection): " + CV_HARDCODED.experience.map(e=>`${e.periode}: ${e.role}`).join(" | ") + ".");
    }
    if (wantsForm){
      ctx.push("Formations: " + CV_HARDCODED.diplomes.map(d=>`${d.titre} (${d.etab}, ${d.periodes})`).join(" | ") + ".");
    }

    // Par défaut, donner un petit socle générique
    if (ctx.length <= 2){
      ctx.push("Résumé compétences: " + CV_HARDCODED.competences.slice(0,4).join("; ") + " …");
    }

    // Règles de ton
    ctx.push("Directives de style: " + PROFILE_GUIDE.regles.join(" | "));

    // Compactage (éviter un pavé)
    let joined = ctx.join("\n");
    if (joined.length > 3600) joined = joined.slice(0, 3600) + " …";
    return joined;
  }

  // ——— Construction du prompt envoyé à l’API ———
  async function prepareQuestion(question){
    const ctx = pickContextFor(question);
    return [
      "Contexte—CV (données fiables) et profil:", ctx,
      "---",
      "Consigne:", 
      "• Réponds de manière concise et précise en t’appuyant sur le contexte ci-dessus quand il est pertinent.",
      "• Si le CV ne comporte pas l’info, dis-le simplement (sans inventer),",
      "  et si c’est lié aux langues/tech/exigences, ajoute qu’il apprend vite et se met à niveau rapidement.",
      `Question: ${question}`
    ].join("\n");
  }
  </script>
  <!-- =================== /CONTEXTE HARDCODÉ =================== -->
</head>

<body>
<header class="site-header">
  <nav class="wrap row" aria-label="Navigation principale" style="padding:10px 16px">
    <a href="/" class="btn ghost">Accueil</a>
    <a href="/portfolio.html" class="btn ghost">Portfolio</a>
    <a href="/cv.html" class="btn ghost">CV</a>
    <a href="/chatbot.html" class="btn" aria-current="page">Chatbot</a>
    <a href="/ai-lab.html" class="btn ghost">Idées IA</a>
    <a href="/fun-facts.html" class="btn ghost">Fun Facts</a>
    <span style="flex:1"></span>
    <span class="tiny"><span class="status-dot ok"></span>Contexte CV intégré</span>
    <a href="/chatbot.html" class="btn">FR</a>
    <a href="/chatbot-en.html" class="btn ghost">EN</a>
    <a href="/chatbot-de.html" class="btn ghost">DE</a>
  </nav>
</header>

<main class="section container chat">
  <h1 class="title">🤖 Chatbot IA</h1>
  <p class="lead">Posez vos questions — pédagogie, IA, expérience. Le bot s’appuie en continu sur mon CV (intégré) et mon profil.</p>

  <div id="chat" class="chat-box" aria-live="polite"></div>

  <div class="row">
    <input id="q" type="text"
           placeholder="Exemple : « Quelles compétences techniques ressortent dans le CV ? »" />
    <button id="send" class="btn primary">Envoyer</button>
  </div>
</main>

<script>
  const chat = document.getElementById('chat');
  function add(text, me=false){
    const p = document.createElement('div');
    p.className = 'msg' + (me ? ' me' : '');
    p.textContent = text;
    chat.appendChild(p);
    chat.scrollTop = chat.scrollHeight;
  }

  // Message d’accueil
  add(
`Bonjour ! Posez une question sur le candidat.

Exemples :
• Quelles compétences techniques ressortent ?
• Parle-moi d’une expérience marquante.
• Quelles langues parle-t-il ? (il apprend vite et se met à niveau si besoin)
(Le bot s’appuie automatiquement sur un extrait intégré du CV.)`
  );

  async function ask(){
    const q = document.getElementById('q');
    const raw = (q.value || "").trim();
    if (!raw) return;
    add(raw, true);
    q.value = "";
    add("…");

    try {
      const withCtx = await prepareQuestion(raw);   // ⬅️ injection systématique du contexte

      const r = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          question: withCtx,
          lang: 'fr'
        })
      });
      const j = await r.json().catch(()=>({}));
      chat.lastChild.textContent = j && j.answer ? j.answer : "D’accord. Pouvez-vous préciser ?";
    } catch (e) {
      chat.lastChild.textContent = "Oups — impossible de répondre pour l’instant.";
      console.error(e);
    }
  }

  document.getElementById('send').addEventListener('click', ask);
  document.getElementById('q').addEventListener('keydown', e => { if (e.key === 'Enter') ask(); });
</script>
</body>
</html>
