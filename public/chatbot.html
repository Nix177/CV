<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Chatbot IA ‚Äî Nicolas Tuor</title>

  <!-- Favicon inline pour √©viter le 404 -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><text y="50%" x="50%" dominant-baseline="middle" text-anchor="middle" font-size="52">ü§ñ</text></svg>'>

  <link rel="stylesheet" href="/style.css">

  <style>
    .chat { max-width: 920px; margin: 0 auto; padding: 16px; }
    .chat-box { background: var(--panel); border:1px solid color-mix(in oklab,var(--ink),transparent 85%); border-radius:16px; padding:16px; box-shadow:var(--shadow); min-height:260px; }
    .msg { background: var(--bg-soft); border:1px solid color-mix(in oklab,var(--ink),transparent 85%); padding:10px 12px; border-radius:12px; margin:10px 0; white-space:pre-wrap }
    .me { border-color: color-mix(in oklab, var(--brand), transparent 70%); }
    .row { display:flex; gap:10px; margin-top:10px; }
    .row input { flex:1; padding:12px; border-radius:10px; border:1px solid color-mix(in oklab,var(--ink),transparent 80%); background: var(--bg-soft); color: var(--ink); }
    .muted { opacity:.85 }
  </style>

  <!-- PDF.js pour lire /CV_Nicolas_Tuor.pdf c√¥t√© navigateur -->
  <script src="https://unpkg.com/pdfjs-dist@4.8.69/build/pdf.min.js"></script>

  <!-- Injection CV c√¥t√© client (auto si la question concerne le CV, ou si l'utilisateur tape /cv ...) -->
  <script>
  (function () {
    "use strict";
    const PAGE_LIMIT = 12000;   // combien de texte max on lit du PDF
    const INJECT_LIMIT = 8000;  // combien on injecte dans la question

    const LABEL = {
      fr: "Contexte CV ‚Äî extrait (utiliser seulement si pertinent) :",
      en: "CV context ‚Äî extract (use only if relevant):",
      de: "CV-Kontext ‚Äî Auszug (nur verwenden, wenn relevant):"
    };

    let CV_TEXT = "";  // cache

    async function loadCv() {
      if (!window.pdfjsLib) return "";
      try {
        pdfjsLib.GlobalWorkerOptions.workerSrc = "https://unpkg.com/pdfjs-dist@4.8.69/build/pdf.worker.min.js";
        // ‚ö†Ô∏è V√©rifie bien le NOM EXACT du fichier dans /public (sensible √† la casse)
        const url = "/CV_Nicolas_Tuor.pdf";
        const doc = await pdfjsLib.getDocument(url).promise;
        let out = "";
        for (let p = 1; p <= doc.numPages; p++) {
          const page = await doc.getPage(p);
          const c = await page.getTextContent();
          out += c.items.map(i => i.str).join(" ") + "\n";
          if (out.length > PAGE_LIMIT) break;
        }
        return out.replace(/\s+/g, " ").trim();
      } catch (e) {
        console.warn("Lecture CV √©chou√©e :", e);
        return "";
      }
    }

    function looksLikeCvQuestion(q) {
      const s = (q || "").toLowerCase().trim();
      if (s.startsWith("/cv ")) return true; // forcer
      return /\b(cv|curriculum|r√©sum√©|resume|lebenslauf|parcours|exp√©riences?|experience|skills?|comp√©tences|dipl[o√¥]me|formation|linkedin|nicolas|tuor)\b/.test(s);
    }

    // API globale utilis√©e par le script de chat
    window.augmentWithCv = async function (question, lang) {
      if (!looksLikeCvQuestion(question)) return question;
      if (!CV_TEXT) CV_TEXT = await loadCv();
      if (!CV_TEXT) return question; // pas de CV dispo ‚Üí on n‚Äôinjecte pas

      const header = LABEL[lang] || LABEL.fr;
      const snippet = CV_TEXT.slice(0, INJECT_LIMIT);
      return `${header}\n${snippet}\n---\nQuestion: ${question.replace(/^\/cv\s*/i, "")}`;
    };
  })();
  </script>
</head>
<body>

<header class="site-header">
  <nav class="wrap row" aria-label="Navigation principale" style="padding:10px 16px">
    <a href="/" class="btn ghost">Accueil</a>
    <a href="/portfolio.html" class="btn ghost">Portfolio</a>
    <a href="/cv.html" class="btn ghost">CV</a>
    <a href="/chatbot.html" class="btn" aria-current="page">Chatbot</a>
    <a href="/ai-lab.html" class="btn ghost">Id√©es IA</a>
    <a href="/fun-facts.html" class="btn ghost">Fun Facts</a>
    <span style="flex:1"></span>
    <a href="/chatbot.html" class="btn">FR</a>
    <a href="/chatbot-en.html" class="btn ghost">EN</a>
    <a href="/chatbot-de.html" class="btn ghost">DE</a>
  </nav>
</header>

<main class="section container chat">
  <h1 class="title">ü§ñ Chatbot IA</h1>
  <p class="lead">Posez vos questions ‚Äî p√©dagogie, IA, exp√©rience. Le bot peut aussi se r√©f√©rer √† mon CV si vous en parlez. <span class="muted">(Astuce : commencez par <code>/cv</code> pour forcer.)</span></p>

  <div id="chat" class="chat-box" aria-live="polite"></div>

  <div class="row">
    <input id="q" type="text"
           placeholder="Exemple : ¬´ /cv Quelles comp√©tences techniques ressortent dans le CV ? ¬ª" />
    <button id="send" class="btn primary">Envoyer</button>
  </div>
</main>

<script>
  const chat = document.getElementById('chat');
  function add(text, me=false){
    const p = document.createElement('div');
    p.className = 'msg' + (me ? ' me' : '');
    p.textContent = text;
    chat.appendChild(p);
    chat.scrollTop = chat.scrollHeight;
  }

  // message d‚Äôaccueil
  add("Bonjour ! Posez une question sur le candidat.\n\nExemples :\n‚Ä¢ /cv Quelles comp√©tences techniques ressortent ?\n‚Ä¢ /cv Parle-moi de ses exp√©riences en enseignement.\n‚Ä¢ A-t-il d√©j√† fait des projets d‚ÄôIA appliqu√©e ?");

  async function ask(){
    const q = document.getElementById('q');
    const raw = (q.value || "").trim();
    if (!raw) return;
    add(raw, true);
    q.value = "";
    add("‚Ä¶");

    try {
      // Injection CV c√¥t√© client (si pertinent)
      const lang = 'fr';
      const question = window.augmentWithCv ? await window.augmentWithCv(raw, lang) : raw;

      const r = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        // L‚ÄôAPI ne change pas. On envoie juste la question possiblement augment√©e.
        body: JSON.stringify({
          question,
          lang,
          // + petit hint facultatif (silencieux si ignor√© par le backend)
          cv_url: '/CV_Nicolas_Tuor.pdf'
        })
      });
      const j = await r.json().catch(()=>({}));
      chat.lastChild.textContent = j && j.answer ? j.answer : "D‚Äôaccord. Pouvez-vous pr√©ciser ?";
    } catch (e) {
      chat.lastChild.textContent = "Oups ‚Äî impossible de r√©pondre pour l‚Äôinstant.";
      console.error(e);
    }
  }

  document.getElementById('send').addEventListener('click', ask);
  document.getElementById('q').addEventListener('keydown', e => { if (e.key === 'Enter') ask(); });
</script>
</body>
</html>
