<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Chatbot IA ‚Äî Nicolas Tuor</title>

  <!-- Favicon inline pour √©viter le 404 -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><text y="50%" x="50%" dominant-baseline="middle" text-anchor="middle" font-size="52">ü§ñ</text></svg>'>

  <link rel="stylesheet" href="/style.css">

  <style>
    .chat { max-width: 920px; margin: 0 auto; padding: 16px; }
    .chat-box { background: var(--panel); border:1px solid color-mix(in oklab,var(--ink),transparent 85%); border-radius:16px; padding:16px; box-shadow:var(--shadow); min-height:260px; }
    .msg { background: var(--bg-soft); border:1px solid color-mix(in oklab,var(--ink),transparent 85%); padding:10px 12px; border-radius:12px; margin:10px 0; white-space:pre-wrap }
    .me  { border-color: color-mix(in oklab, var(--brand), transparent 70%) }
    .row { display:flex; gap:10px; margin-top:10px }
    .row input { flex:1; padding:12px; border-radius:10px; border:1px solid color-mix(in oklab,var(--ink),transparent 80%); background: var(--bg-soft); color: var(--ink) }
    .muted { opacity:.85 }
    .tiny  { font-size:.85rem; opacity:.8 }
    .status-dot{ display:inline-block; width:8px; height:8px; border-radius:999px; margin-right:6px; translate:0 -1px }
    .ok { background:#16a34a }
    .ko { background:#ef4444 }
  </style>

  <!-- PDF.js pour lire /CV_Nicolas_Tuor.pdf c√¥t√© navigateur -->
  <script src="https://unpkg.com/pdfjs-dist@4.8.69/build/pdf.min.js"></script>

  <!-- ======== Injection CV syst√©matique (robuste & compacte) ======== -->
  <script>
  (function () {
    "use strict";

    const PDF_URL = "/CV_Nicolas_Tuor.pdf";          // ‚ö†Ô∏è nom exact dans /public
    const PAGE_CHAR_LIMIT = 16000;                    // max caract√®res lus du PDF
    const CONTEXT_MAX_CHARS = 3600;                   // max extrait inject√© / requ√™te
    const CACHE_KEY = "cv_ctx_v3_fr";                 // cache session

    // Elements status
    let cvStatusEl = null;
    function setCvStatus(ok){
      if (!cvStatusEl) cvStatusEl = document.getElementById("cvStatus");
      if (!cvStatusEl) return;
      cvStatusEl.innerHTML = `<span class="status-dot ${ok?'ok':'ko'}"></span>${ok?'CV : charg√©':'CV : indisponible'}`;
    }

    // Utilitaires
    function norm(s){ return (s||"").replace(/\s+/g," ").trim(); }
    function sliceLines(s, n){
      // coupe proprement sur ~n caract√®res, en respectant les puces/retours
      if (!s) return "";
      if (s.length <= n) return s;
      const cut = s.slice(0, n);
      const lastBreak = Math.max(cut.lastIndexOf("\n"), cut.lastIndexOf(". "), cut.lastIndexOf("; "));
      return (lastBreak>200? cut.slice(0, lastBreak) : cut) + " ‚Ä¶";
    }
    const RGX = {
      compet: /(COMP[√âE]TENCES?)[\s\S]*?(?=\n[A-Z√â√à√Ä√Ç√ä√é√î√õ√Ñ√ñ√ú0-9 ,.'‚Äô\-]{5,}\n|$)/i,
      exp:    /(EXP[√âE]RIENCES?(?: DIVERSES?)?|PARCOURS|PROJETS)[\s\S]*?(?=\n[A-Z√â√à√Ä√Ç√ä√é√î√õ√Ñ√ñ√ú0-9 ,.'‚Äô\-]{5,}\n|$)/i,
      form:   /(FORMATIONS?|[√âE]TUDES)[\s\S]*?(?=\n[A-Z√â√à√Ä√Ç√ä√é√î√õ√Ñ√ñ√ú0-9 ,.'‚Äô\-]{5,}\n|$)/i,
      inter:  /(CENTRES? D[‚Äô']INT[√âE]R[√äE]T|INT[√âE]R[√äE]TS|HOBBIES?|LOISIRS?)[\s\S]*?(?=\n[A-Z√â√à√Ä√Ç√ä√é√î√õ√Ñ√ñ√ú0-9 ,.'‚Äô\-]{5,}\n|$)/i,
      langs:  /(LANGUES?)[\s\S]*?(?=\n[A-Z√â√à√Ä√Ç√ä√é√î√õ√Ñ√ñ√ú0-9 ,.'‚Äô\-]{5,}\n|$)/i
    };

    // Lecture PDF -> texte brut
    async function readPdfText() {
      try {
        if (!window.pdfjsLib) return "";
        pdfjsLib.GlobalWorkerOptions.workerSrc = "https://unpkg.com/pdfjs-dist@4.8.69/build/pdf.worker.min.js";
        const doc = await pdfjsLib.getDocument(PDF_URL).promise;
        let out = "";
        for (let p=1; p<=doc.numPages; p++){
          const page = await doc.getPage(p);
          const c = await page.getTextContent();
          out += c.items.map(i=>i.str).join(" ") + "\n";
          if (out.length > PAGE_CHAR_LIMIT) break;
        }
        return norm(out);
      } catch (e) {
        console.warn("Lecture CV √©chou√©e :", e);
        return "";
      }
    }

    function pickSection(txt, re, label){
      const m = txt.match(re);
      if (!m) return "";
      const body = norm(m[0].replace(/^[^\n]*\n?/,""));
      const bulletified = body
        .replace(/(?:‚Ä¢|\u2022)\s*/g, " ‚Ä¢ ")
        .replace(/\s-\s/g, " ‚Ä¢ ")
        .replace(/\s{2,}/g, " ");
      return bulletified ? `- ${label}: ${bulletified}` : "";
    }

    function buildContext(full) {
      // ordonne les sections (tr√®s court + puces conserv√©es si pr√©sentes)
      const parts = [];
      const comp = pickSection(full, RGX.compet, "Comp√©tences");
      const exp  = pickSection(full, RGX.exp,    "Exp√©rience");
      const frm  = pickSection(full, RGX.form,   "Formation");
      const hob  = pickSection(full, RGX.inter,  "Centres d‚Äôint√©r√™t");
      const lng  = pickSection(full, RGX.langs,  "Langues");

      if (comp) parts.push(comp);
      if (exp)  parts.push(exp);
      if (frm)  parts.push(frm);
      if (hob)  parts.push(hob);
      if (lng)  parts.push(lng);

      let ctx = parts.join("\n");
      if (!ctx) ctx = sliceLines(full, CONTEXT_MAX_CHARS);   // fallback

      return sliceLines(ctx, CONTEXT_MAX_CHARS);
    }

    async function ensureCvContext() {
      // Cache sessionStorage pour acc√©l√©rer
      const cached = sessionStorage.getItem(CACHE_KEY);
      if (cached) { setCvStatus(true); return cached; }
      const raw = await readPdfText();
      if (!raw) { setCvStatus(false); return ""; }
      const ctx = buildContext(raw);
      if (ctx) {
        sessionStorage.setItem(CACHE_KEY, ctx);
        setCvStatus(true);
      } else {
        setCvStatus(false);
      }
      return ctx;
    }

    // API globale : **toujours** injecter le contexte (si disponible)
    window.prepareQuestionWithCv = async function(userQuestion, lang="fr") {
      const cv = await ensureCvContext();
      if (!cv) return userQuestion; // on n‚Äôemp√™che pas de r√©pondre si CV KO
      // Consigne forte + extrait. Important : rester court et explicite.
      return [
        "Contexte CV (utiliser si pertinent) :",
        cv,
        "---",
        "Consigne : r√©ponds √† la question en t‚Äôappuyant sur le CV ci-dessus lorsqu‚Äôil est pertinent. " +
        "S‚Äôil n‚Äôest pas pertinent, r√©ponds normalement sans pr√©tendre ne pas avoir acc√®s au CV.",
        `Question : ${userQuestion}`
      ].join("\n");
    };

    // Expose aussi un indicateur initial (affiche ¬´ chargement‚Ä¶ ¬ª)
    document.addEventListener("DOMContentLoaded", () => {
      setCvStatus(false);
      // Pr√©-charger en arri√®re-plan pour gagner du temps √† la 1re question
      ensureCvContext();
    });
  })();
  </script>
  <!-- ======== /Injection CV ======== -->
</head>
<body>

<header class="site-header">
  <nav class="wrap row" aria-label="Navigation principale" style="padding:10px 16px">
    <a href="/" class="btn ghost">Accueil</a>
    <a href="/portfolio.html" class="btn ghost">Portfolio</a>
    <a href="/cv.html" class="btn ghost">CV</a>
    <a href="/chatbot.html" class="btn" aria-current="page">Chatbot</a>
    <a href="/ai-lab.html" class="btn ghost">Id√©es IA</a>
    <a href="/fun-facts.html" class="btn ghost">Fun Facts</a>
    <span style="flex:1"></span>
    <span id="cvStatus" class="tiny muted"><span class="status-dot ko"></span>CV : chargement‚Ä¶</span>
    <a href="/chatbot.html" class="btn">FR</a>
    <a href="/chatbot-en.html" class="btn ghost">EN</a>
    <a href="/chatbot-de.html" class="btn ghost">DE</a>
  </nav>
</header>

<main class="section container chat">
  <h1 class="title">ü§ñ Chatbot IA</h1>
  <p class="lead">Posez vos questions ‚Äî p√©dagogie, IA, exp√©rience. Le bot a acc√®s √† mon CV et peut s‚Äôy r√©f√©rer automatiquement.</p>

  <div id="chat" class="chat-box" aria-live="polite"></div>

  <div class="row">
    <input id="q" type="text"
           placeholder="Exemple : ¬´ Quelles comp√©tences techniques ressortent dans le CV ? ¬ª" />
    <button id="send" class="btn primary">Envoyer</button>
  </div>
</main>

<script>
  const chat = document.getElementById('chat');
  function add(text, me=false){
    const p = document.createElement('div');
    p.className = 'msg' + (me ? ' me' : '');
    p.textContent = text;
    chat.appendChild(p);
    chat.scrollTop = chat.scrollHeight;
  }

  // message d‚Äôaccueil
  add(
`Bonjour ! Posez une question sur le candidat.

Exemples :
‚Ä¢ Quelles comp√©tences techniques ressortent ?
‚Ä¢ Parle-moi d‚Äôune exp√©rience marquante.
‚Ä¢ Quels sont ses centres d‚Äôint√©r√™t ?
(Le bot peut exploiter mon CV automatiquement.)`
  );

  async function ask(){
    const q = document.getElementById('q');
    const raw = (q.value || "").trim();
    if (!raw) return;
    add(raw, true);
    q.value = "";
    add("‚Ä¶");

    try {
      // üîó ALWAYS: question + extrait CV compact (si dispo)
      const withCv = window.prepareQuestionWithCv
        ? await window.prepareQuestionWithCv(raw, 'fr')
        : raw;

      const r = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          question: withCv,
          lang: 'fr',
          // petit hint facultatif si ton backend le supporte :
          cv_url: '/CV_Nicolas_Tuor.pdf'
        })
      });
      const j = await r.json().catch(()=>({}));
      chat.lastChild.textContent = j && j.answer ? j.answer : "D‚Äôaccord. Pouvez-vous pr√©ciser ?";
    } catch (e) {
      chat.lastChild.textContent = "Oups ‚Äî impossible de r√©pondre pour l‚Äôinstant.";
      console.error(e);
    }
  }

  document.getElementById('send').addEventListener('click', ask);
  document.getElementById('q').addEventListener('keydown', e => { if (e.key === 'Enter') ask(); });
</script>
</body>
</html>
